'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[49],{868:function(A,u,a){a.r(u);A={};a.r(A);u=a(5);var c=a(95),b=a(6),h=a(0),r=a(15);class f{constructor(M,Q,H,ba,U,D){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=M;this.WebAffinitizedUrl=Q;this.PolicyCookie=H;this.PolicyCookieTTL=ba;this.WasServiceDown=U;this.AffinitizedUrl=D}}Object(h.a)(f,"SafeLinksData",
null,[]);class l{constructor(M,Q){this.n1c=M;this.stopwatch=Q}}Object(h.a)(l,"SafeLinksGetUrlReputationRequestData",null,[]);var m=a(47),x=a(59);class n{constructor(M,Q,H,ba){this.JUj=U=>{let D="OnGetUrlReputationSuccessCallback: ",I=10;const X=U.data.state;try{const Y=m.b(U.data.responseData).reputationResults[0],ja=Y.navigateUrl.length,Ua=X.n1c.length,ka=Y.navigateUrl===X.n1c;Y.navigateUrl&&0<Y.navigateUrl.length&&(X.n1c=Y.navigateUrl);D+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
U.data.httpStatus,Y.verdict,Ua.toString(),ja.toString(),ka.toString());I=50}catch(Y){D+=String.format("Exception {0}",Y.message)}this.yPf(X,D,I)};this.IUj=U=>{let D="OnGetUrlReputationFailureCallback: ";const I=U.data.state;try{D+=String.format("HttpStatus {0}",U.data.httpStatus)}catch(X){D+=String.format("Exception {0}",X.message)}this.yPf(I,D,10)};this.Ga=M;this.Yn=Q;this.kmh=H;n.Io=ba}OCa(M,Q,H){try{var ba=null;n.Io&&(ba=n.Io.Li("WebServiceCall","SafeLinksGetUrlReputation"));const U=new l(Q,ba);
ba={};ba.AffinitizedUrl=M;ba.TargetUrl=Q;ba.PolicyCookie=H;const D=m.c(ba);this.Yn.ov(this.kmh,2,D,null,!1,2,this.JUj,this.IUj,U,void 0,void 0,3E3,3E3,"36");return!0}catch(U){r.ULS.sendTraceTag(588788033,378,10,U.message)}return!1}yPf(M,Q,H){M.stopwatch&&(M.stopwatch.stop(),M.stopwatch=null);r.ULS.sendTraceTag(588788034,378,H,Q);x.a.Cm(M.n1c,void 0,"noopener,noreferrer","SafeLinksNav")}}n.Io=null;Object(h.a)(n,"SafeLinksNavigationHelper",null,[]);var t;(function(M){M[M.mml=0]="enabledByPolicy";M[M.Xpf=
1]="disabledByPolicy";M[M.cml=2]="disabled_GetPolicyFailure";M[M.dml=3]="disabled_PendingGetPolicyRequest"})(t||(t={}));Object(h.b)("SafeLinksNavigationState",t);var w=a(107),v=a(202),k=a(942),y=a(288),C=a(241),B=a(858),E=a(35),K=a(189),F=a(357);class W{constructor(M,Q,H,ba=!1,U=null,D=null){this.rTa=this.qTa=0;this.wWb=this.Mfc=!1;this.kFa=null;this.ccb=!0;this.Gjc=null;this.GVi=Y=>{let ja=C.a.IKj,Ua="";try{this.Mfc=this.wWb=!1;var ka=Y.data.state;const Ia=({stopwatch:ka}=this.p0c(ka)).returnValue,
Sa=Object.assign({},{durationMs:Ia});w.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",Sa);r.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",Y.data.httpStatus,Y.data.responseData.length,Ia);if(Y.data.httpStatus!==C.a.HL)Ua="Unexpected httpStatus: "+Y.data.httpStatus.toString();else{ka=null;try{ka=m.b(Y.data.responseData)}catch(Ya){Ua="Exception:"+Ya.toString()+" deserializing response";return}if(ka){var fb=
ka.IsSafeLinksEnabled;if(void 0===fb||null===fb||0>=fb.length)Ua="Invalid isSafeLinksEnabledString";else{r.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",fb);var ha=W.cce(fb);if(void 0===ka.WebAffinitizedUrl||null===ka.WebAffinitizedUrl||0>=ka.WebAffinitizedUrl.length)Ua="Invalid WebAffinitizedUrl";else if(void 0===ka.PolicyCookie||null===ka.PolicyCookie||0>=ka.PolicyCookie.length)Ua="Invalid PolicyCookie";else if(void 0===ka.PolicyCookieTTL||null===ka.PolicyCookieTTL)Ua=
"Invalid PolicyCookieTTL";else{var ea=ka.WebAffinitizedUrl,aa=ka.PolicyCookie,ca=ka.AffinitizedUrl,xa=new Date;xa.setMinutes(xa.getMinutes()+(5<ka.PolicyCookieTTL?ka.PolicyCookieTTL-5:0));var Oa=xa.getTime(),ua=new f(fb,ea,aa,Oa,!1,ca);this.oOg(ua);ja=Y.data.httpStatus;this.kFa&&(ha?(this.h3g(this.kFa),this.rTa=this.qTa=0):(r.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",
!0,!0,null),x.a.H0(this.kFa)),this.kFa=null)}}}else Ua="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Ia){Ua="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Ia.toString()}finally{ja!==C.a.HL&&this.xPf(ja,Ua)}};this.FVi=Y=>{this.Mfc=!1;let ja=500,Ua="";try{let ka=Y.data.state;const fb=({stopwatch:ka}=this.p0c(ka)).returnValue,ha=Object.assign({},{durationMs:fb});ja=Y.data.httpStatus;w.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest",
"HttpStatusCode_"+ja.toString(),!1,!0,ha);Ua="Request Failed, Status="+B.a[Y.data.status]+" Duration: "+fb}catch(ka){Ua="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+ka.toString()}finally{this.xPf(ja,Ua)}};r.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.Ga=M;this.Yn=Q;this.DG=H;W.Io=D;this.Cvh=ba?this.Ga.Ya("SafeLinksHandlerWebServiceBase"):this.Ga.Ya("WebServiceBase");this.mvh=this.Ga.Ya("SafeLinksHashedUserId");this.ofl=this.Ga.Ya("SafeLinksWorkloadIdHeaderValue");
this.vhc=this.Ga.Lj("SafeLinksMaxGetPolicyBootRetries",2);this.whc=this.Ga.Lj("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.ugc=this.isSafeLinksEnabledForUser();this.tgc=this.Lqj();W.N_e=this.Ga.Ya("UserPrincipalName")||"";W.LZe=this.Ga.Ya("TenantId")||"";r.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.ugc,this.tgc);if(this.ugc&&this.tgc){Q=(M=this.MJa())?M.IsSafeLinksEnabled.toLowerCase():"";H=this.yYd();r.ULS.sendTraceTag(36231312,378,
50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",Q,H);var I=!M||"unknown"===Q||M.WasServiceDown||H,X=v.a.wy();X&&(X.set("shouldGetSafeLinksDataFromServer",I.toString()),X.set("isSafeLinksEnabledCacheValue",Q.toString()));U?(this.ccb=!1,U.execute(Y=>{Y.isFeatureEnabled("MsoUrlreputation",!0).then(ja=>{this.ccb=ja;X.set("isUserLicensedForSafeLinks",this.ccb.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",F.b.FailureBased,"jpittsdirects",X);this.ccb&&I&&
this.qCc(!0);return null})})):(w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",F.b.FailureBased,"jpittsdirects",X),I&&this.qCc(!0))}}get appName(){return this.DG}get q5c(){return this.Cvh}get userId(){return this.mvh}get nNf(){try{if(""===W.vbd){const M={};M["X-AppName"]=this.appName;M["X-AppVersion"]=b.AFrameworkApplication.buildVersion;M.OS=this.Ga.Ya("PlatformNameAndVersion")||"";const Q=JSON.stringify(M);W.vbd=window.self.btoa(Q)}}catch(M){r.ULS.sendTraceTag(508909765,378,10,"GetUrlReputationAdditionalProperties Error: {0}",
M.message)}return W.vbd}get USi(){const M=this.q5c?this.q5c+"/":"",Q=new y.QueryStringBuilder("SafeLinksHandler.ashx");Q.fq("app",this.appName);this.Ga.ka("SafeLinksUseDebugHeader")&&Q.fq("action","debug");this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&Q.fq("s2satpop","1");this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&Q.fq("s2se03","1");return String.format("{0}{1}&{2}",M,Q.toString(),b.AFrameworkApplication.Jo)}get VZi(){const M=
this.q5c?this.q5c+"/":"",Q=new y.QueryStringBuilder("SafeLinksHandler.ashx");Q.fq("app",this.appName);this.Ga.ka("SafeLinksUseDebugHeader")&&Q.fq("action","debug");this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&Q.fq("s2satpop","1");this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&Q.fq("s2saat","1");this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&Q.fq("s2se03","1");this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",
!1)&&Q.fq("sladpar",this.nNf);Q.fq("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",M,Q.toString(),b.AFrameworkApplication.Jo)}get DJj(){W.Djd||(W.Djd=new n(this.Ga,this.Yn,this.VZi,W.Io));return W.Djd}OCa(M){if(!M)return r.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var Q=this.umj(M);r.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",
Q,this.ugc,this.tgc,this.ccb);if(!(Q&&this.ugc&&this.tgc&&this.ccb))return!1;Q=0;const H=({state:Q}=this.NNk()).returnValue;r.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",t[Q]);const ba=v.a.wy();ba&&ba.set("SafeLinksNavigationState",t[Q]);w.Health.instance.recordKpiUsage("SafeLinksNavigations",F.b.FailureBased,"jpittsdirects",ba);if(!H)return 2!==Q&&3!==Q||w.Health.instance.recordKpiFailure("SafeLinksNavigations",t[Q],!1,!0,null),!1;r.ULS.sendTraceTag(26019601,
378,50,"Using safelinks to navigate hyperlink");if(this.XNk())return this.yYd()?!1:this.DJj.OCa(this.lEi(),M,this.qKf());if(!this.yYd())return this.h3g(M),!0;this.kFa=M;r.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.wWb=!1;this.qCc();return!0}umj(M){M=M.toLowerCase();const Q=this.Ga.Ez("SafeLinksUnsupportedProtocols");if(Q)for(let H=0;H<Q.length;H++)if(M.startsWith(Q[H]))return!1;return!0}qCc(M=!1){var Q=v.a.wy();Q&&Q.set("isOnBootRequest",M.toString());
w.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",F.b.SuccessBased,"jpittsdirects",Q);w.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",F.b.FailureBased,"jpittsdirects",Q);Q=this.$yd("SafeLinksGetPolicy");this.Yn.ov(this.USi,1,null,null,!0,2,this.GVi,this.FVi,Q,void 0,void 0,void 0,void 0,"23");this.wWb=M;this.Mfc=!0;M?this.qTa++:this.rTa++}xPf(M,Q=""){try{if(r.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",M,Q),this.qTa<
this.vhc&&this.rTa<this.whc)this.qCc(this.wWb);else{this.wWb=!1;r.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.qTa,this.rTa,M,Q);Q=null;const H=v.a.wy();H&&(H.set("HttpStatus",M.toString()),Q=Object.assign({},{extendedProperties:H}));w.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,Q);const ba=new f("false","","",0,!0,"");this.oOg(ba);this.kFa&&
(r.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),x.a.H0(this.kFa),this.kFa=null)}}catch(H){r.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",H.toString())}}h3g(M){const Q=this.qKf(),H=this.P_i(),ba={};ba.Url=M;ba.SafeLinksCookie=Q;ba.CorrelationId=K.a.create().toString();ba.WorkloadId=
this.ofl;ba.UserAgentInfo=E.a.v$+"|"+this.appName;this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&(ba.User=W.N_e,ba.TenantId=W.LZe,ba.AdditionalProperties=this.nNf);r.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",ba.CorrelationId);x.a.l3b(x.a.Y2(4),H,ba)}isSafeLinksEnabledForUser(){const M=this.Ga.Ya("IsSafeLinksEnabledForUser");return M?W.cce(M):!1}Lqj(){const M=this.Ga.Ez("SafeLinksDisabledBrowsers");if(E.a.g1){if(this.Ga.Nv("SafeLinksForTeamsIsEnabled")&&
this.Ga.ka("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(M,"Electron"))return!1}else if(Array.contains(M,E.a.v$))return!1;return"officecomhwa"===(this.Ga.Ya(b.AFrameworkApplication.a_)||"").toLowerCase()?!1:!0}XNk(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&E.a.j1?!0:E.a.g1||E.a.nKc}NNk(){let M;M=0;const Q=this.MJa(),H=Q?Q.IsSafeLinksEnabled:"";if(""!==H)return Q.WasServiceDown?
(r.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===H.toLowerCase()?(r.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:W.cce(H),state:M};if(this.Mfc)return M=3,r.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:M};if(this.qTa>=this.vhc||this.rTa>=this.whc)return M=2,r.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",
this.qTa,this.vhc,this.rTa,this.whc),{returnValue:!1,state:M};r.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.vhc+this.whc-(this.qTa+this.rTa));return{returnValue:!0,state:M}}qKf(){const M=this.MJa();return M?M.PolicyCookie:""}P_i(){const M=this.MJa();return M?M.WebAffinitizedUrl:""}lEi(){const M=this.MJa();return M?M.AffinitizedUrl:""}mLi(){const M=
new Date;try{const Q=this.MJa();M.setTime(Q?Q.PolicyCookieTTL:0)}catch(Q){r.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",Q)}return M}yYd(){const M=this.mLi();return!!M&&M.getTime()<Date.now()}MJa(){if(!this.Gjc){const M=k.a.instance.getItem(this.userId);if(!M||""===M)return null;this.Gjc=JSON.parse(M)}return this.Gjc}oOg(M){if(void 0===M||null===M)throw Error.argumentNull("safeLinksData");if(void 0===M.IsSafeLinksEnabled||null===M.IsSafeLinksEnabled||
0>=M.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.Gjc=M;M.WasServiceDown||this.yfl(M)}yfl(M){M=JSON.stringify(M);k.a.instance.setItem(this.userId,M)}$yd(M){return void 0!==W.Io&&null!==W.Io?W.Io.Li("WebServiceCall",M):null}p0c(M){if(void 0!==M&&null!==M){const Q=M.zi;M.stop();return{returnValue:Q,stopwatch:null}}return{returnValue:null,stopwatch:M}}static cce(M){return"false"!==M.toLowerCase()?!0:!1}}W.Io=null;W.Djd=null;W.LZe="";W.N_e="";W.vbd="";Object(h.a)(W,
"SafeLinksManager",null,[263]);const J=M=>{switch(M){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},L=M=>{switch(M){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Object(c.b)(u.xf,{Fk:"singleton"})(()=>new W(b.AFrameworkApplication.fa,b.AFrameworkApplication.rj,String.format("{0}-{1}",J(b.AFrameworkApplication.ra.$g.kn),L(b.AFrameworkApplication.ra.$g.oNa))));String(A);window.___1710758652305_closurehack=A},
942:function(A,u,a){a.d(u,"a",function(){return b});A=a(0);var c=a(15);class b{constructor(){this.SEa=!1}getItem(h){try{if(b.zha(h)&&this.localStorage)return this.localStorage.getItem(h)}catch(r){c.ULS.sendTraceTag(593512200,306,15,"LocalStorageWrapper Exception: {0} ",r.message)}return null}setItem(h,r){try{b.zha(h)&&this.localStorage&&this.localStorage.setItem(h,r)}catch(f){c.ULS.sendTraceTag(593512199,306,15,"LocalStorageWrapper Exception: {0} ",f.message)}}removeItem(h){try{b.zha(h)&&this.localStorage&&
this.localStorage.removeItem(h)}catch(r){c.ULS.sendTraceTag(593512198,306,15,"LocalStorageWrapper Exception: {0} ",r.message)}}get localStorage(){let h=null;if(!this.SEa)try{localStorage&&(h=localStorage)}catch(r){this.SEa=!0}return h}static get instance(){b.Va||(b.Va=new b);return b.Va}static zha(h){return void 0===h||null===h||0>=h.length?!1:!0}}b.Va=null;Object(A.a)(b,"LocalStorageWrapper",null,[107])}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.safelinks.js.map/43f605fe193f27ef56fc8d32f4c92157/EwaTS.safelinks.js.map