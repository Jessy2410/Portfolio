'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[46],{864:function(A,u,a){a.r(u);var c={};a.r(c);a.d(c,"SensitivityCommandHandler",function(){return w});var b=a(135),h=a(0),r=a(6),f=a(211);class l{}l.CVk="sbProtectForm14";l.FVk="SBStatusBarMarkAsReadOnly14";l.Awj="Info_16x16x32";l.VKb="QuickSearchCompletedToday_16x16x32";l.age="CommonControlCheckboxCheck_16";l.c1g="On";l.visible="Visible";l.syi="ImageIsVisible";l.gF="SourceControlId";l.menuItemId="MenuItemId";
l.menu="Menu";l.$qd="AppLockId";l.value="Value";l.yo="LabelText";l.alt="Alt";l.UTf="Image16by16";l.Vna="Image16by16Class";l.BVk="SBProtectForm_16";l.EVk="SBStatusBarMarkAsReadOnly_16";l.icon="Icon";l.iconColor="IconColor";l.customTooltip="CustomTooltip";l.Cek="MipTagDynamicFillWithOutline_20";l.Dek="MipTagLockDynamicFillWithOutline_20";l.Bek="MipTagErrorOutline_20";l.Eek="MipTagQuestionOutline_20";l.r2c="transparent";l.A4k="UILocation";Object(h.a)(l,"PolicyConstants",null,[]);var m=a(26),x=a(67),
n=a(5),t=a(95);let w=class{constructor(Ta){this.$=Ta}Ri(){return!1}executeCommand(Ta,Hb,uc){switch(Hb.command){case m.a.setSensitivity:return this.$.workbookContext.FileCoauthorable||(uc[l.$qd]=this.$.workbookContext.ExclusiveLockId),Ta=r.AFrameworkApplication.yh.ek(m.a.setSensitivity,2,uc),x.Task.Ua(32===Ta);case m.a.jca:return Ta=r.AFrameworkApplication.yh.ek(m.a.jca,2,uc),x.Task.Ua(32===Ta);case m.a.G7:return Ta=r.AFrameworkApplication.yh.ek(m.a.G7,2,uc),x.Task.Ua(32===Ta);default:return f.a(Hb.command)}}Gi(Ta,
Hb){switch(Hb.command){case m.a.setSensitivity:case m.a.jca:case m.a.G7:return!0;default:return!1}}dj(Ta,Hb,uc){switch(Hb){case "PopulateSensitivityFlyout":return 32===r.AFrameworkApplication.yh.ek(m.a.lOa,2,uc);default:return!1}}};w=Object(b.__decorate)([Object(t.d)(n.Df),Object(b.__param)(0,Object(n.Nb)())],w);Object(h.a)(w,"SensitivityCommandHandler",null,[34]);var v=a(42),k=a(1192),y=a(1494),C=a(285);const B=()=>v.a.instance.resolve("Common.App.Policy.Contracts.IPolicyManager");var E=a(15),K=
a(142),F=a(1170),W=a(650),J=a(210),L=a(648);class M{constructor(Ta,Hb,uc=null){this.id=Ta.Id;uc||(uc="");this.Ffk=uc;this.sensitivityLabel=Ta}}Object(h.a)(M,"AutoPolicyLabelData",null,[]);class Q{constructor(Ta,Hb){this.AX=Ta;this.displayName=Hb}}Object(h.a)(Q,"PolicyLabelRequestState",null,[]);class H{constructor(){this.Ine=this.x7d=""}}Object(h.a)(H,"PolicyStrings",null,[]);var ba=a(240),U=a(22);class D extends ba.a{constructor(Ta,Hb){super(!1,!1,!0);this.IEa=null;this.Mcc=!1;this.IAg=uc=>{let Sc=
"";1===uc&&this.IEa&&(Sc=this.IEa);this.NN(uc,this.tsh,Sc)};this.NVj=uc=>{this.IEa=uc;uc=this.validate();this.Mcc!==uc&&(this.Mcc=uc,this.jRa(Object(U.a)("SensitivityJustificationTitle"),this.IAg,this.NKf(this.Mcc)))};this.tsh=Ta;this.NN=Hb;this.kl=D.id;this.ti(1,Object(U.a)("DialogChange"));this.l8(1,!1);this.dja(0)}kte(){this.initializeAndShow(Object(U.a)("SensitivityJustificationTitle"),this.IAg,this.NKf(this.Mcc))}NKf(Ta){return{["id"]:this.kl,["bodyControls"]:{["choiceGroupProps"]:{},["textAreaProps"]:{["placeholder"]:Object(U.a)("SensitivityJustificationPlaceholder")}},
["actionButtonProps"]:{["label"]:Object(U.a)("DialogChange"),["disabled"]:!Ta},["infoMessage"]:Object(U.a)("SensitivityJustificationMessage"),["justificationIrrelevantLabel"]:Object(U.a)("SensitivityJustificationNoLongerApplies"),["justificationIncorrectLabel"]:Object(U.a)("SensitivityJustificationIncorrect"),["justificationOtherLabel"]:Object(U.a)("SensitivityJustificationOther"),["onJustificationUpdated"]:this.NVj}}static get R2(){return r.AFrameworkApplication.ra.$g.$M&&r.AFrameworkApplication.ra.$g.Q1f}}
D.id="JustificationDialog";Object(h.a)(D,"JustificationDialog",ba.a,[]);class I extends ba.a{constructor(Ta,Hb,uc){super(!1,!1,!0);this.jEj=(bc,vc)=>{1===bc&&vc.selectedLabel&&(bc=vc.selectedLabel,""!==bc&&this.skh(bc))};if(Ta&&uc){var Sc={["id"]:"MandatoryLabellingDialog"};this.skh=uc;this.qfd=Hb;if(!r.AFrameworkApplication.fa.ka("MandatoryLabelingDialogLearnMoreSwitchIsEnabled")||this.qfd&&""!==this.qfd)Hb={["href"]:this.qfd,["target"]:"_blank"},Sc.learnMoreLink={["type"]:"AppLinkProps",["id"]:"mandatoryLabellingLearnMoreLink",
["text"]:Object(U.a)("LearnMore"),["handler"]:Hb,["customTooltip"]:Object(U.a)("LearnMoreTooltip")};Hb={["sections"]:[],["shouldAutoOpen"]:!1};Array.add(Hb.sections,{["id"]:"mandatoryLabellingFlyoutMenuSection",["controls"]:Ta});Sc.labelFlyout={["type"]:"AppFlyoutAnchorProps",["id"]:"mandatoryLabellingFyout",["label"]:"Pick a label",["hideLabel"]:!1,["hideChevron"]:!1,["hideIcon"]:!0,["menuDefinition"]:Hb};Ta={["id"]:"MandatoryLabellingDialog",["bodyControls"]:Sc};Sc.initialLabelText=Object(U.a)("MandatoryLabellingDialogInitialLabelText");
Sc.descriptionText=Object(U.a)("MandatoryLabellingDialogDescriptionText");this.initializeAndShow(Object(U.a)("MandatoryLabellingDialogBusinessBarTitle"),this.jEj,Ta)}else E.ULS.sendTraceTag(560547850,306,10,"MandatoryLabelingDialog was triggered with invalid inputs")}}Object(h.a)(I,"MandatoryLabellingDialog",ba.a,[]);class X{constructor(){this.FDb=!!r.AFrameworkApplication.ra&&r.AFrameworkApplication.ra.$g.$M}w7h(Ta,Hb,uc){this.FDb&&new I(Ta,Hb,uc)}static get instance(){return X.Va||(X.Va=new X)}}
X.Va=null;Object(h.a)(X,"MandatoryLabellingDialogFactory",null,[703]);var Y=a(687),ja=a(289),Ua=a(227),ka=a(664),fb=a(107),ha=a(169),ea=a(101),aa=a(488),ca=a(432),xa=a(117),Oa=a(498),ua=a(188),Ia=a(482),Sa=a(122),Ya=a(33),da=a(136),Ea=a(357),oa=a(113);const za=Ta=>{var Hb;return Ta?Ta.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnablePolicyPackageRefactoring",!1):null===(Hb=r.AFrameworkApplication.fa)||void 0===Hb?void 0:Hb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnablePolicyPackageRefactoring",
!1)};class la extends Sys.EventArgs{constructor(Ta){super();this.TYk=Ta}}Object(h.a)(la,"WatermarkChangeEventArgs",Sys.EventArgs,[]);class Ca{constructor(Ta,Hb,uc,Sc,bc=[]){this.UDb=this.Esa=null;this.aed=this.ved=this.JDb=this.oQe=this.$Re=this.y$c=!1;this.Mab=this.esa=this.Yka=this.DDa=this.IEa=this.v3=this.jFa=this.Tda=null;this.Jjh=this.h8c=0;this.Thd=null;this.hh=new oa.a;this.dEb="";this.VGb=new Map;this.OLe=this.qed=this.w8c=null;this.Wgk=()=>{this.aed&&!this.UGc()&&(this.aed=!1,this.$l.value.Vgk())};
this.iEj=vc=>{this.LEd(this.aSe[vc])};this.Iee=()=>{if(!this.$l.value.N2f()){var vc=this.IC[this.sm.AppliedPolicyId];this.JDb&&this.DDa&&this.Mab!==this.DDa.id&&(!vc||vc.Order<this.DDa.sensitivityLabel.Order)&&(vc=this.j8a(this.DDa.id,{},4),32!==vc?E.ULS.sendTraceTag(50868813,306,10,"ProcessAutoSensitivityLabel: SetSensitivityByPolicyId failed with response: "+vc):(this.Mab=this.DDa.id,this.esa&&(vc=this.IC[this.esa])&&vc.Order<=this.DDa.sensitivityLabel.Order&&(this.$l.value.oqa(29),this.esa=null)));
vc=this.IC[this.sm.AppliedPolicyId];if(this.Yka&&this.esa!==this.Yka.id&&(!vc||vc.Order<this.Yka.sensitivityLabel.Order)){const Xc=this.Yka.id;this.$l.value.oqa(29);vc=za(this.Ga)?this.$l.value.xna(this.Yka.sensitivityLabel):this.xna(this.Yka.sensitivityLabel);this.$l.value.xHb(29,Object(U.a)("PolicyBusinessBarTitle"),String.format(Object(U.a)("PolicyLabelRecommendationMessage"),vc)+" "+this.Yka.Ffk,Object(U.a)("PolicyLabelRecommendationButton"),()=>{this.j8a(Xc,{},8)});this.esa=this.Yka.id}this.Yka=
this.DDa=null}};this.Y1h=(vc,Xc,ad)=>{1===vc?this.$wb(Xc===this.sm.AppliedPolicyId?"":Xc,ad):this.Mm.XB()};this.$Mh=vc=>{1===vc&&this.$l.value.Cdk()};this.Svc=()=>32;this.V0j=(vc,Xc)=>{Xc.S1&&this.IC&&(vc=this.IC[this.sm.AppliedPolicyId])&&(this.esa&&(Xc=this.IC[this.esa])&&Xc.Order<=vc.Order&&(this.$l.value.oqa(29),this.esa=null),this.Mab&&this.Mab!==vc.Id&&(this.$l.value.oqa(28),this.Mab=null))};this.$f=Ta;this.Mm=Hb;this.Ga=uc;this.$l=Sc;this.zEb={};this.cVe={};this.aSe={};this.iGc=uc.ka("WacApplyManualPolicyLabelIsEnabled");
this.$l.value.X4e(this.Iee);this.$l.value.Wpd(this.Iee);this.$l.value.bIb(this.V0j);r.AFrameworkApplication.ra&&r.AFrameworkApplication.ra.rDh(this.Wgk);this.I1a()&&bc.forEach(vc=>this.VGb.set(vc.watermarkElement,vc));uc.ka("SupportsPolicies")&&uc.Ya("AppliedPolicyId")&&(this.Esa=uc.Ya("IrmPolicyTitle"),this.UDb=uc.Ya("IrmPolicyDescription"));this.Xhh=this.Ga.Lj("SetPolicyLabelAwaitFileExistsOnHostMaxRetries",6);this.Yhh=this.Ga.Lj("SetPolicyLabelAwaitFileExistsOnHostRetryDelayMs",5E3)}get ILa(){return r.AFrameworkApplication.ILa||
!!this.qed&&this.qed()}ho(){this.$f.Uh(m.a.fbe,da.a.frame,this.Svc);this.$f.dl(m.a.Bub,da.a.frame,Object(K.a)(this,this.Bub,"queryPolicyLabel"),96);this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpQueryShortLabelEnabled",!1)&&(this.$f.Uh(m.a.Xsg,da.a.frame,this.Svc),this.$f.dl(m.a.Q3b,da.a.frame,Object(K.a)(this,this.Q3b,"queryPolicyShortLabel"),96));this.$f.Uh(m.a.S9a,da.a.frame,Object(K.a)(this,this.S9a,"toggleSensitivity"));this.$f.Uh(m.a.lOa,da.a.frame,Object(K.a)(this,this.lOa,
"populateSensitivityFlyout"));this.$f.Uh(m.a.setSensitivity,da.a.frame,Object(K.a)(this,this.setSensitivity,"setSensitivity"));this.$f.dl(m.a.Cub,da.a.frame,Object(K.a)(this,this.Cub,"querySensitivity"),96);this.$f.Uh(m.a.G7,da.a.frame,Object(K.a)(this,this.G7,"querySensitivityToggleButton"));this.$f.Uh(m.a.jca,da.a.frame,Object(K.a)(this,this.jca,"querySensitivitySubFlyout"));this.cHb(m.a.S9a)||this.$f.Mwb(m.a.S9a,4);this.cHb(m.a.lOa)||this.$f.Mwb(m.a.lOa,4);this.cHb(m.a.setSensitivity)||this.$f.Mwb(m.a.setSensitivity,
4);this.cHb(m.a.G7)||this.$f.Mwb(m.a.G7,4);this.cHb(m.a.jca)||this.$f.Mwb(m.a.jca,4);this.Mm.XB();r.AFrameworkApplication.fa&&xa.a("isSharedUxGateEnabled")&&appChrome.api.isSharedUxGateEnabled("SharedOnline.ChangeGate.DelayPolicyActionRegistration")&&this.$l.value.jnk(Object(K.a)(this,this.xCg,"registerActionsHandler"))}xCg(){this.ho()}R2c(){this.$f.ZD(m.a.fbe,da.a.frame,this.Svc);this.$f.ZD(m.a.Bub,da.a.frame,Object(K.a)(this,this.Bub,"queryPolicyLabel"));this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpQueryShortLabelEnabled",
!1)&&(this.$f.ZD(m.a.Xsg,da.a.frame,this.Svc),this.$f.ZD(m.a.Q3b,da.a.frame,Object(K.a)(this,this.Q3b,"queryPolicyShortLabel")));this.$f.ZD(m.a.S9a,da.a.frame,Object(K.a)(this,this.S9a,"toggleSensitivity"));this.$f.ZD(m.a.lOa,da.a.frame,Object(K.a)(this,this.lOa,"populateSensitivityFlyout"));this.$f.ZD(m.a.setSensitivity,da.a.frame,Object(K.a)(this,this.setSensitivity,"setSensitivity"));this.$f.ZD(m.a.Cub,da.a.frame,Object(K.a)(this,this.Cub,"querySensitivity"));this.$f.ZD(m.a.G7,da.a.frame,Object(K.a)(this,
this.G7,"querySensitivityToggleButton"));this.$f.ZD(m.a.jca,da.a.frame,Object(K.a)(this,this.jca,"querySensitivitySubFlyout"))}S9a(){return 32}YDf(Ta){const Hb="mandatoryLabelling_"+Ta.Id;this.aSe[Hb]=Ta.Id;return{["type"]:"AppToggleButtonProps",["id"]:Hb,["label"]:Ta.DisplayName,["hideLabel"]:!1,["customTooltip"]:Ta.Tooltip}}HXd(){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpLouderLabelEnabled",!1)}get sm(){if(za(this.Ga))return this.$l.value.Nn;this.Tda||(this.Tda=this.$l.value.Nn);
return this.Tda}get IC(){return za(this.Ga)?this.$l.value.aX:this.v3}get r5a(){return za(this.Ga)?this.$l.value.cFb:this.jFa}KPi(){const Ta=[];for(const uc in this.r5a){var Hb=this.r5a[uc];const Sc=this.IC[uc];if(Sc&&Sc.Enabled&&!Sc.HasUserDefinedPermissions)if(Hb.count){const bc={["sections"]:[],["shouldAutoOpen"]:!1},vc={["id"]:"mandatoryLabelling_flyoutMenuSection_"+Sc.Id,["controls"]:[]};for(const Xc of Hb)(Hb=this.IC[Xc])&&Hb.Enabled&&!Hb.HasUserDefinedPermissions&&Array.add(vc.controls,this.YDf(Hb));
Array.add(bc.sections,vc);Array.add(Ta,{["type"]:"AppFlyoutAnchorProps",["id"]:"mandatoryLabelling_"+Sc.Id,["label"]:Sc.DisplayName,["hideLabel"]:!1,["hideChevron"]:!1,["hideIcon"]:!1,["menuDefinition"]:bc})}else Array.add(Ta,this.YDf(Sc))}return Ta}lOa(Ta,Hb,uc,Sc,bc){if(1===uc||!this.$l.value.Lea(!0))return 32;bc.MenuItems=Object.assign(new aa.a,{Id:"SensitivityList",MenuSectionList:[],UpdateDynamically:!0});Array.add(bc.MenuItems.MenuSectionList,this.ji(!this.isReactRibbonEnabled()));this.sm.CustomUrl&&
Array.add(bc.MenuItems.MenuSectionList,this.k7h(this.isReactRibbonEnabled()?this.sm.CustomUrl:Ya.a.qm(this.sm.CustomUrl)));this.isReactRibbonEnabled()||(bc.PopulationXML=Ua.q(bc.MenuItems));return 32}Cub(Ta,Hb,uc,Sc,bc){if(1===uc||!bc||!this.iGc)return 32;za(this.Ga)||(this.Tda=this.$l.value.Nn);if(this.$l.value.Lea(!0)&&(bc[l.visible]=!0,this.oQe||(ea.a("MipLabelsAvailable"),this.oQe=!0),this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpLouderLabelTUIEnabled",!1)&&this.sm.AreLabelsAvailable&&
(Ta=Object(W.a)()))){let vc;vc=za(this.Ga)?this.sm.AppliedPolicyId?"LouderLabel_LabelExistsOnLoadActivity":"LouderLabel_NoLabelAppliedOnLoadActivity":Ca.Im(this.sm.AppliedPolicyId)?"LouderLabel_NoLabelAppliedOnLoadActivity":"LouderLabel_LabelExistsOnLoadActivity";Ta.execute(Xc=>{Xc.logActivity(vc,null)})}return 32}G7(Ta,Hb,uc,Sc,bc){if(1===uc||!bc)return 32;let vc,Xc;bc[l.c1g]=!!(vc=bc[l.menuItemId])&&!!(Xc=this.zEb[vc])&&Xc===this.sm.AppliedPolicyId;return 32}jca(Ta,Hb,uc,Sc,bc){if(1===uc||!bc)return 32;
let vc,Xc,ad;Ta=!!(vc=bc[l.gF])&&!!(Xc=this.zEb[vc])&&!!(ad=this.r5a[Xc])&&ad.contains(this.sm.AppliedPolicyId);bc[l.syi]=Ta;bc[l.c1g]=Ta;return 32}setSensitivity(Ta,Hb,uc,Sc,bc){if(1===uc||!bc)return 32;Ta=this.zEb[bc[l.gF]];ea.a("SensitivityPickerUsage",void 0,void 0,[{name:"SensitivityPickerLocation",int64:this.B4k(bc[l.A4k])}]);return this.j8a(Ta,bc,2)}UGc(){return!!r.AFrameworkApplication.ra&&1===r.AFrameworkApplication.ra.mode}b2g(){this.sm.DefaultLabelId&&this.sm.MandatoryLabelingEnforced?
this.y$c||this.UGc()?this.sm.AppliedPolicyId?this.LEd(""):(this.$l.value.oqj(this.$l.value.$Yb)||this.UGc())&&this.Itf():this.OOg():this.sm.DefaultLabelId?this.OOg():this.sm.MandatoryLabelingEnforced&&(this.sm.AppliedPolicyId?this.LEd(""):this.Itf())}q0f(){return this.sm.MandatoryLabelingEnforced?this.sm&&this.sm.AreLabelsAvailable?this.Ga.ka("TestOverrideIsReactDialogEnabled")||this.Mm&&this.Mm.$g&&this.Mm.$g.$M?!0:(E.ULS.sendTraceTag(539109065,306,50,"Mandatory labelling not invoked b/c react dialogs disabled!"),
!1):(E.ULS.sendTraceTag(539109064,306,50,"Mandatory labelling not invoked b/c there are no sensitivity labels!"),!1):(E.ULS.sendTraceTag(539109063,306,50,"Mandatory labelling not invoked b/c user did not have policy!"),!1)}Itf(){!this.q0f()||r.AFrameworkApplication.oha||this.$Re||(this.$Re=r.AFrameworkApplication.oha=!0,E.ULS.sendTraceTag(562837517,306,50,"Mandatory labelling is invoked successfully."),this.$l.value.Czg("",1),this.$l.value.tod(37,Object(U.a)("MandatoryLabellingDialogBusinessBarTitle"),
Object(U.a)("MandatoryLabellingDialogDescriptionText"),Object(U.a)("MandatoryLabellingDialogBusinessBarButton"),()=>{this.hEj()}))}LEd(Ta){this.q0f()&&r.AFrameworkApplication.oha&&(r.AFrameworkApplication.oha=!1,E.ULS.sendTraceTag(562837518,306,50,"Mandatory labelling is escaped successfully."),this.$l.value.qie(),this.$l.value.Czg(Ta,2))}hEj(){X.instance.w7h(this.KPi(),this.sm.CustomUrl,this.iEj)}y$e(){return this.Ga.ka("CoAuthForProtectedFilesEnabled")&&this.Ga.ka("SupportsOfficeClientCoauthoring")&&
this.Ga.ka("SetPolicyLabelAwaitFileExistsOnHostIsEnabled")&&!!this.OLe&&this.ILa}j8a(Ta,Hb,uc){this.$l.value.xdk(uc);let Sc=32,bc=!1,vc=!0;const Xc=this.IC[Ta],ad=2===uc||8===uc||16===uc,Id=Ta===this.sm.AppliedPolicyId;if(this.w8c&&this.w8c(Ta,ad))E.ULS.sendTraceTag(42860829,306,15,"SetSensitivity : As app doesn't support changing the label, skipping SetSensitivity call. ApplyLabelFlag : {0}",uc),this.Mm.XB();else if(Hb&&l.$qd in Hb&&this.$l.value.fFk(Hb[l.$qd]),Ta)if(this.$l.value.N2f()||this.y$e()&&
this.ved)E.ULS.sendTraceTag(42796168,306,50,"Policy label cannot be set because a set policy label request is already in progress. ApplyLabelFlag: {0}",uc),this.Mm.XB(),ad&&this.znc(Object(U.a)("SensitivityApplicationDialogErrorTitle"),Object(U.a)("SensitivityQuickApplicationErrorMessage"));else if(this.Ga.ka("HasDocumentEditRights"))if(this.$l.value.KTh(Ta))if((za(this.Ga)?null===Xc||void 0===Xc?0:Xc.HasUserDefinedPermissions:this.v3[Ta]&&this.v3[Ta].HasUserDefinedPermissions)&&!Id)E.ULS.sendTraceTag(540608323,
306,50,"UDP label cannot be applied during UDP in WAC Phase 1. ApplyLabelFlag: {0}",uc),1!==uc&&4!==uc&&this.BGh();else if(ad&&this.sm.MandatoryLabelingEnforced&&Id)E.ULS.sendTraceTag(570972054,306,50,"Policy label cannot be removed due to mandatory labeling. ApplyLabelFlag: {0}",uc),this.znc(Object(U.a)("MandatoryLabellingBlockLabelRemovalDialogTitle"),Object(U.a)("MandatoryLabellingBlockLabelRemovalDialogDescriptionText"));else{if(ad&&this.Ga.ka("WacLabelingJustificationDialogIsEnabled")&&this.sm.RequiredDowngradeJustification&&
(Id||(za(this.Ga)?null===Xc||void 0===Xc?0:Xc.RequiredDowngradeJustification:this.v3[Ta].RequiredDowngradeJustification))&&!this.IEa)return E.ULS.sendTraceTag(570972055,306,50,"Downgrade justification is required. ApplyLabelFlag: {0}",uc),this.kte(Ta),Sc;if(this.y$e()&&!this.OLe())this.h8c<this.Xhh?(E.ULS.sendTraceTag(577356770,306,50,"File does not exist on host, retrying after delay. RetryCount: {0} ApplyLabelFlag: {1}",this.h8c,uc),this.ved=!0,this.h8c++,x.Task.delay(this.Yhh).continueWith(()=>
{this.ved=!1;this.j8a(Ta,Hb,uc)})):(E.ULS.sendTraceTag(577356771,306,15,"Policy label cannot be set because maximum retries were reached checking for file existence. ApplyLabelFlag: {0}",uc),bc=1!==uc,vc=!1,Sc=8);else{if(this.Moj(Ta)&&(E.ULS.sendTraceTag(553911752,306,15,"Policy label cannot be set because the selected label is a parent label. ApplyLabelFlag: {0}",uc),1===uc||8===uc||4===uc))return Sc;E.ULS.sendTraceTag(570972056,306,50,"SetSensitivityByPolicyId is succeeded. ApplyLabelFlag: {0}",
uc);this.$wb(Id?"":Ta,this.IEa,uc);return Sc}}else E.ULS.sendTraceTag(42796169,306,50,"Policy label cannot be set because the user is in a coauth session. ApplyLabelFlag: {0}",uc),this.Mm.XB(),ad&&this.znc(Object(U.a)("SensitivityApplicationDialogErrorTitle"),Object(U.a)("SensitivityCoauthApplicationErrorMessage"));else E.ULS.sendTraceTag(558892739,306,50,"Policy label cannot be set because the user doesn't have edit rights. ApplyLabelFlag: {0}",uc),this.Mm.XB(),ad&&this.znc(Object(U.a)("SensitivityApplicationDialogErrorTitle"),
Object(U.a)("SensitivityNoEditRightsErrorMessage"));else E.ULS.sendTraceTag(42796167,306,15,"Policy label cannot be set because the selected policy ID is null. ApplyLabelFlag: {0}",uc),this.Mm.XB(),bc=ad,vc=!1,Sc=8;this.$l.value.Mfe(0,uc,bc,vc);return Sc}Qod(Ta){Ta.forEach(Hb=>{this.VGb.set(Hb.watermarkElement,Hb)});this.BIh(Ta);return{}}iFh(Ta){this.hh.addHandler("watermarkChangeHandlerEventKey",Ta)}apk(Ta){this.hh.removeHandler("watermarkChangeHandlerEventKey",Ta)}ufb(Ta,Hb,uc=null,Sc=!1){fb.Health.instance.recordKpiUsage("MipAutoClassificationSetLabel",
Ea.b.FailureBased,"wordclpfc",null);this.Ga.ka("SupportsOfficeClientCoauthoring")&&this.Ga.ka("CoAuthForProtectedFilesIsEnabled")?(this.JDb=!1,za(this.Ga)||(this.Tda=this.$l.value.Nn),this.sm&&!this.sm.AppliedPolicyId?this.JDb=!0:this.sm&&this.sm.PolicyLabelAssignmentMethod&&(this.JDb=Sa.e(this.sm.PolicyLabelAssignmentMethod)===Sa.e("standard"))):this.JDb=Sc;za(this.Ga)?(Ta=Ta?this.IC[Ta]:null,Hb=Hb?this.IC[Hb]:null):(Ta=Ca.Im(Ta)?null:this.v3[Ta],Hb=Ca.Im(Hb)?null:this.v3[Hb]);Hb?this.Yka=new M(Hb,
!0,uc):(this.$l.value.oqa(29),this.esa=null);Ta?this.DDa=new M(Ta,!1):this.Mab=null;this.Iee(null,null);return 32}KIh(Ta){""!==this.sm.AppliedPolicyId?this.$l.value.Mfe(14,16,!0):this.j8a(Ta,null,16)}IPg(){this.v3={};za(this.Ga)||(this.Tda=this.$l.value.Nn);if(this.sm)for(const Ta of this.sm.SensitivityLabels)this.v3[Ta.Id]=Ta}Moj(Ta){if(!za(this.Ga)&&!this.jFa)return!1;if(Ta in this.r5a){Ta=this.r5a[Ta];for(const Hb of Ta)if((Ta=this.IC[Hb])&&Ta.Enabled)return!0}return!1}wQg(){this.jFa={};za(this.Ga)||
(this.Tda=this.$l.value.Nn);if(this.sm){for(const Ta of this.sm.SensitivityLabels)Ta.ParentId||(this.jFa[Ta.Id]=new J.a);for(const Ta of this.sm.SensitivityLabels)this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableSensitivityLabelingInOfficeJS",!1)?Ta.ParentId&&Ta.ParentId in this.jFa&&(this.v3[Ta.ParentId]&&(Ta.ParentName=this.v3[Ta.ParentId].DisplayName),Ta.Enabled&&this.jFa[Ta.ParentId].add(Ta.Id)):Ta.ParentId&&Ta.ParentId in this.jFa&&Ta.Enabled&&this.jFa[Ta.ParentId].add(Ta.Id)}}Tyg(){za(this.Ga)||
(this.Tda=this.$l.value.Nn);const Ta=this.iGc&&this.isReactRibbonEnabled()&&this.$l.value.Lea();Ca.GVc(Ta)}rhk(Ta){this.w8c=Ta}kik(Ta){this.qed=Ta}OOg(){if(this.Ga.ka("WacApplyDefaultPolicyLabelIsEnabled"))if(this.UGc())this.aed=!0;else if(!this.y$c&&(this.y$c=!0,za(this.Ga)||(this.Tda=this.$l.value.Nn),this.sm&&this.sm.DefaultLabelId))if(!this.sm.AppliedPolicyId)E.ULS.sendTraceTag(509732190,306,50,"Default labeling triggered. DefaultLabelType: {0}",this.sm.DefaultLabelType),this.j8a(this.sm.DefaultLabelId,
null,1);else if(L.a.zm().equals(this.sm.DefaultLabelType,"documentLibraryDefault")){const Ta=this.IC[this.sm.AppliedPolicyId],Hb=this.IC[this.sm.DefaultLabelId];this.sm.AppliedPolicyId!==this.sm.DefaultLabelId&&L.a.zm().equals(this.sm.PolicyLabelAssignmentMethod,"standard")&&Ta.Order<Hb.Order&&(E.ULS.sendTraceTag(509732189,306,50,"Default labeling triggered. DefaultLabelType: {0}",this.sm.DefaultLabelType),this.j8a(this.sm.DefaultLabelId,null,1))}}I1a(){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarking",
!1)||this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)}$wb(Ta,Hb,uc=2){this.IEa=Hb;this.I1a()&&this.cie();this.$l.value.$wb(Ta);this.Mm.XB();Hb=this.IC[Ta];const Sc=za(this.Ga)?this.$l.value.xna(Hb):this.xna(Hb);uc=new Q(uc,Sc);this.I1a()&&this.doc(Hb,Array.from(this.VGb.values()));this.$l.value.PYc(Ta,this.IEa,uc)}oWd(Ta){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?"Microsoft FTE"===
Ta.DisplayName:Ta.AppliesDynamicWatermarking}oLd(Ta){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?"Watermark Text":Ta.DynamicWatermarkingText}hAg(Ta){if(null!==Ta&&this.oWd(Ta)){Ta=this.oLd(Ta);var Hb=Object(U.a)("WatermarkTextScreenReaderTemplate");Hb=void 0!==Hb?Hb.replace(/\{0\}/g,Ta):Ta;this.dEb!==Hb&&(this.dEb=Hb,this.hh.raiseEvent("watermarkChangeHandlerEventKey",new la(Hb)))}else this.dEb=""}cie(){xa.c()&&(E.ULS.sendTraceTag(507348994,
306,50,"Remove Watermark is invoked successfully"),appChrome.removeWatermark(),this.hAg(null))}BIh(Ta){this.IC&&this.sm.AppliedPolicyId?this.doc(this.IC[this.sm.AppliedPolicyId],Ta):E.ULS.sendTraceTag(507348993,306,15,"Watermark is not applied as sensitivity label is not available.")}doc(Ta,Hb){Ta?this.$l.value.oWd(Ta)&&xa.c()&&(E.ULS.sendTraceTag(507348963,306,50,"Apply Watermark is invoked successfully"),appChrome.applyWatermark(Hb,this.$l.value.oLd(Ta)),this.hAg(Ta)):E.ULS.sendTraceTag(507348992,
306,15,"Watermark is not applied as sensitivity label is not available.")}kte(Ta){(new D(Ta,this.Y1h)).kte()}znc(Ta="",Hb=""){const uc=new ua.a;uc.GC=r.AFrameworkApplication.GVb;uc.Ph=0;uc.ti(1,Object(U.a)("DialogClose"));uc.pW(Ta,Hb,null)}BGh(){const Ta=new ua.a;Ta.GC=r.AFrameworkApplication.GVb;Ta.Ph=1;Ta.ti(1,Object(U.a)("OICDownLoadACopyDialogOpenButton"));Ta.ti(0,Object(U.a)("DialogClose"));Ta.pW(Object(U.a)("SensitivityApplicationDialogErrorTitle"),Object(U.a)("SensitivityBlockUDPSetLabelMessage"),
this.$Mh)}isReactRibbonEnabled(){return!!this.Mm&&!!this.Mm.$g&&this.Mm.$g.Oq}Mo(){return this.Mm&&this.Mm.$g?this.Mm.$g.Mo:!1}eGk(Ta,Hb,uc,Sc){Ta?(Sc[l.value]=Ta,Sc[l.yo]=Ta,Sc[l.customTooltip]=Hb,this.QPg(uc,r.AFrameworkApplication.protectedFile,Sc)):(Sc[l.iconColor]=l.r2c,this.sm.MandatoryLabelingEnforced?(Sc[l.value]=Sc[l.yo]=this.XBc().Ine,Sc[l.icon]=l.Bek):(Sc[l.value]=Sc[l.yo]=this.XBc().x7d,Sc[l.icon]=l.Eek));Sc[l.visible]=!0}UEk(Ta){let Hb="",uc="",Sc="";if(this.sm.AreLabelsAvailable){let bc=
null;this.IC&&(bc=this.IC[this.sm.AppliedPolicyId]);let vc="";this.I1a()&&(vc=this.dEb,this.cie());bc&&(this.I1a()&&(this.dEb=vc,this.doc(bc,Array.from(this.VGb.values()))),Hb=za(this.Ga)?this.$l.value.xna(bc):this.xna(bc),uc=bc.Tooltip,this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)||(r.AFrameworkApplication.protectedFile=this.$l.value.Doa(bc)),Sc=this.HKd(bc));if(!this.$l.value.Lea()&&!bc)return}else{if(this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.TitleBarSensitivityBufferEnabled",
!1))Hb=this.Esa?this.Esa:"";else{if(!this.Esa)return;Hb=this.Esa}Sc=l.r2c;uc=this.UDb?this.UDb:""}this.eGk(Hb,uc,Sc,Ta)}Bub(Ta,Hb,uc,Sc,bc){if(1===uc)return 32;za(this.Ga)||(this.Tda=this.$l.value.Nn);if(!this.sm||!bc)return 32;bc[l.value]="";bc[l.yo]="";bc[l.alt]=null;bc[l.UTf]=null;bc[l.Vna]=null;bc[l.customTooltip]="";bc[l.visible]=!1;bc[l.iconColor]="";bc[l.icon]="";if(this.HXd())this.UEk(bc);else{uc=Hb=Ta="";if(!this.sm.AreLabelsAvailable){if(!this.Esa)return 32;Ta=this.Esa;uc=l.r2c;this.UDb&&
(Hb=this.UDb)}else if(this.sm.AppliedPolicyId){Sc=null;for(const vc of this.sm.SensitivityLabels)if(vc.Id.toLowerCase()===this.sm.AppliedPolicyId.toLowerCase()){Sc=vc;break}this.I1a()&&this.cie();Sc&&(this.I1a()&&this.doc(Sc,Array.from(this.VGb.values())),Ta=za(this.Ga)?this.$l.value.xna(Sc):this.xna(Sc),Hb=Sc.Tooltip,this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)||(r.AFrameworkApplication.protectedFile=this.$l.value.Doa(Sc)),uc=this.HKd(Sc))}Ta&&
(bc[l.value]=Ta,bc[l.yo]=Ta,this.Mo()?bc[l.customTooltip]=Hb:bc[l.alt]=Hb,this.QPg(uc,r.AFrameworkApplication.protectedFile,bc),bc[l.visible]=!0)}return 32}Q3b(Ta,Hb,uc,Sc,bc){if(1===uc)return 32;za(this.Ga)||(this.Tda=this.$l.value.Nn);if(!this.sm||!bc)return 32;bc[l.yo]="";if(this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpUseHideBarByDefaultSetting",!1)&&this.sm.HideBarByDefault)return 32;Ta="";if(this.sm.AreLabelsAvailable)if(this.sm.AppliedPolicyId){if(!this.IC)return 32;(Hb=
this.IC[this.sm.AppliedPolicyId])&&(Ta=Hb.ParentId&&this.IC[Hb.ParentId]?za(this.Ga)?Hb.ParentName:this.IC[Hb.ParentId].DisplayName:Hb.DisplayName)}else Ta=this.sm.MandatoryLabelingEnforced?this.XBc().Ine:this.XBc().x7d;else{if(!this.Esa)return 32;Ta=this.Esa}bc[l.yo]=Ta;return 32}xna(Ta){return Ta?this.v3?Ta.ParentId&&this.v3[Ta.ParentId]?this.v3[Ta.ParentId].DisplayName+"\\"+Ta.DisplayName:Ta.DisplayName:(E.ULS.sendTraceTag(4282E4,306,15,"Policy ID to Sensitivity label dictionary has not been initialized."),
Ta.DisplayName):""}QPg(Ta,Hb,uc){this.HXd()?(uc[l.icon]=this.FMf(Hb),uc[l.iconColor]=this.GMf(Ta)):this.Mo()?uc[l.icon]=Hb?l.BVk:l.EVk:(uc[l.UTf]=r.AFrameworkApplication.JE,uc[l.Vna]=Hb?ha.c(l.CVk):ha.c(l.FVk))}k7h(Ta){const Hb=this.h0("LearnMoreSection",!0);Ta=Object.assign(new ja.a,{Id:"SensitivityLearnMore",ExternalId:"SensitivityLearnMore",MenuItemId:Ta,LabelText:Object(U.a)("LearnMore"),Command:za(this.Ga)?m.a.openUrlInNewTab.toString():"1959943459",Image16by16:r.AFrameworkApplication.JE,Image16by16Class:ha.c(l.Awj),
Visible:!0,Alt:Object(U.a)("LearnMoreTooltip"),KeyTip:"L"});Array.add(Hb.ControlList,Ta);return Hb}Dmf(Ta,Hb,uc=!1){let Sc;Sc="Toggle_"+Ta.Id;Sc="Sensitivity_"+Sc;const bc=Ta.DisplayName,vc=Ta.Tooltip;var Xc=Ta.Id===this.sm.AppliedPolicyId,ad=uc?Ya.a.qm(Sc):Sc;this.HXd()?(Xc=this.HKd(Ta),Hb=Object.assign(new Oa.a,{Id:ad,ExternalId:ad,LabelText:uc?Ya.a.qm(bc):bc,Command:za(this.Ga)?m.a.setSensitivity.toString():"2935633379",MenuItemId:ad,QueryCommand:za(this.Ga)?m.a.G7.toString():"991261903",Visible:!0,
Alt:uc?Ya.a.qm(vc):vc,AriaLabel:Ia.a.uoc,IconColor:this.GMf(Xc),KeyTip:Hb}),Hb.ExternalImageId=this.FMf(this.$l.value.Doa(Ta))):(ad=Object.assign(new Y.a,{Id:ad,ExternalId:ad,LabelText:uc?Ya.a.qm(bc):bc,Command:za(this.Ga)?m.a.setSensitivity.toString():"2935633379",MenuItemId:ad,QueryCommand:za(this.Ga)?m.a.G7.toString():"991261903",CheckedImage:r.AFrameworkApplication.JE,Visible:!0,Alt:uc?Ya.a.qm(vc):vc,IsChecked:Xc,AriaLabel:Ia.a.uoc,KeyTip:Hb}),this.isReactRibbonEnabled()?(ad.CheckedImageClass=
ha.c(l.age),ad.ExternalImageId=l.age):ad.CheckedImageClass=ha.c(l.VKb),Hb=ad);ad=Sc;this.zEb[ad]=Ta.Id;this.cVe[Ta.Id]=ad;return Hb}h0(Ta,Hb=!1){return Object.assign(new ca.a,{Title:"",Id:Ta,DisplayMode:l.menu,ShowMenuSectionSeparator:Hb,ControlsId:"Ctrl_"+Ta,ControlList:[]})}r$h(Ta,Hb,uc){Ta=this.h0(Ta+"Sub");let Sc=1;for(const bc of Hb)(Hb=this.IC[bc])&&Hb.Enabled&&(Array.add(Ta.ControlList,this.Dmf(Hb,Sc.toString(),uc)),Sc++);return Ta}ji(Ta=!1){const Hb=this.h0("SensitivitySection");let uc=1;
for(const Sc in this.r5a){const bc=this.r5a[Sc],vc=this.IC[Sc];if(vc&&vc.Enabled){if(bc.count){const Xc="Label"+this.Jjh++,ad=Object.assign(new ka.a,{Id:Xc,ExternalId:Xc,LabelText:Ta?Ya.a.qm(vc.DisplayName):vc.DisplayName,Command:za(this.Ga)?m.a.alwaysEnabled.toString():"798637440",QueryCommand:za(this.Ga)?m.a.jca.toString():"2875864574",Menu:Object.assign(new aa.a,{Title:"",MenuSectionList:[],UpdateDynamically:!0}),ImageIsVisible:!1,Toggled:!1,ImageUsesSpaceWhileInvisible:!0,AriaLabel:Ia.a.uoc,KeyTip:uc.toString(),
Alt:Ta?Ya.a.qm(vc.Tooltip):vc.Tooltip});this.isReactRibbonEnabled()?ad.ExternalImageId=l.age:(ad.Image16by16=r.AFrameworkApplication.JE,ad.Image16by16Class=ha.c(l.VKb));Array.add(ad.Menu.MenuSectionList,this.r$h(Xc,bc,Ta));Array.add(Hb.ControlList,ad);this.zEb[ad.Id]=vc.Id;this.cVe[vc.Id]=ad.Id}else Array.add(Hb.ControlList,this.Dmf(vc,uc.toString(),Ta));uc++}}return Hb}cHb(Ta){return!!this.$f.hY(Ta)&&!!this.$f.hY(Ta).flags&&!!this.$f.hY(Ta).flags.length}FMf(Ta){return Ta?l.Dek:l.Cek}GMf(Ta){return Ta?
Ta:l.r2c}HKd(Ta){if(Ta.Color||!Ta.ParentId)return Ta.Color;const Hb=this.IC[Ta.ParentId];return Hb?Hb.Color:Ta.Color}B4k(Ta){switch(Ta){case 2:case 14:case 15:return 1;case 21:return 2;default:return 0}}XBc(){this.Thd||(this.Thd=Object.assign(new H,{x7d:HeaderStrings.NoSensitivityLabel,Ine:HeaderStrings.SelectASensitivityLabel}));return this.Thd}static t$k(){r.AFrameworkApplication.fa&&!r.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpLouderLabelEnabled",!1)||!xa.c()||
appChrome.api.dispatch(appChrome.actions.updateControlHiddenState("OpenDocumentLabelPane",!0))}static GVc(Ta){xa.c()&&appChrome.api.dispatch(appChrome.actions.updateControlHiddenState("Sensitivity",!Ta))}static Im(Ta){return Ta&&Ta.length?!1:!0}}Object(h.a)(Ca,"PolicyActor",null,[689]);var Va=a(768),ia=a(1263),wa;(function(Ta){Ta[Ta.unknown=0]="unknown";Ta[Ta.oll=1]="boot";Ta[Ta.refresh=2]="refresh";Ta[Ta.Mul=3]="selfSetPolicyLabel"})(wa||(wa={}));Object(h.b)("GetPolicyLabelsReason",wa);class Jb extends Sys.EventArgs{constructor(Ta,
Hb,uc,Sc,bc,vc){super();this.ZJb=Ta;this.title=Hb;this.message=uc;this.buttonText=Sc;this.Tla=bc;this.qXb=vc}}Object(h.a)(Jb,"AddAutoPolicyBusinessBarEntryEventArgs",Sys.EventArgs,[]);class $a extends Sys.EventArgs{constructor(Ta,Hb,uc,Sc,bc){super();this.ZJb=Ta;this.title=Hb;this.message=uc;this.buttonText=Sc;this.Tla=bc}}Object(h.a)($a,"AddMandatoryLabellingBusinessBarEntryEventArgs",Sys.EventArgs,[]);var Ka;(function(Ta){Ta[Ta.none=0]="none";Ta[Ta.reasonDefaultLabel=1]="reasonDefaultLabel";Ta[Ta.reasonManual=
2]="reasonManual";Ta[Ta.reasonAutomatic=4]="reasonAutomatic";Ta[Ta.reasonRecommended=8]="reasonRecommended";Ta[Ta.reasonMandatory=16]="reasonMandatory";Ta[Ta.reasonAI=32]="reasonAI"})(Ka||(Ka={}));Object(h.b)("ApplyLabelFlags",Ka);class nb extends Sys.EventArgs{constructor(Ta,Hb,uc){super();this.ygf=Ta;this.xgf=Hb;this.existingLabelPriority=uc}}Object(h.a)(nb,"AutoCLPSecurityNodesEventArgs",Sys.EventArgs,[]);class sa extends Sys.EventArgs{constructor(){super()}}Object(h.a)(sa,"GetPolicyLabelEventArgs",
Sys.EventArgs,[]);class na extends Sys.EventArgs{constructor(){super()}}Object(h.a)(na,"GetPolicyLabelFailureEventArgs",Sys.EventArgs,[]);var ab=a(1353),Ja=a(1154);class Pa extends Sys.EventArgs{constructor(Ta=!1,Hb=null,uc=null,Sc=null){super();this.S1=Ta;this.aoc=Hb;this.context=uc;this.BQg=Sc}}Object(h.a)(Pa,"LabelInfoUpdateEventArgs",Sys.EventArgs,[]);class hb extends Sys.EventArgs{constructor(Ta,Hb){super();this.RMa=Ta;this.j7e=Hb}}Object(h.a)(hb,"MandatoryLabellingAppHandlerEventArgs",Sys.EventArgs,
[]);class ac extends Sys.EventArgs{constructor(Ta,Hb,uc,Sc){super();this.title=Ta;this.hSc=Hb;this.buttonText=uc;this.Jhg=Sc}}Object(h.a)(ac,"PolicyTipEventArgs",Sys.EventArgs,[]);class Hc extends Sys.EventArgs{constructor(Ta,Hb){super();this.ZJb=Ta;this.qXb=Hb}}Object(h.a)(Hc,"RemoveAutoPolicyBusinessBarEntryEventArgs",Sys.EventArgs,[]);class bd extends Sys.EventArgs{constructor(){super()}}Object(h.a)(bd,"RemoveMandatoryLabellingBusinessBarEntryEventArgs",Sys.EventArgs,[]);class zc extends Sys.EventArgs{constructor(Ta,
Hb){super();this.gSc=Ta;this.AX=Hb}}Object(h.a)(zc,"SetPolicyLabelEventArgs",Sys.EventArgs,[]);class oc extends Sys.EventArgs{constructor(Ta,Hb,uc,Sc=null,bc=null,vc=null,Xc=null){super();this.errorType=Ta;this.lVg=uc;this.title=Sc;this.message=bc;this.buttonText=vc;this.Tla=Xc}}Object(h.a)(oc,"SetPolicyLabelFailureEventArgs",Sys.EventArgs,[]);class Nb extends Sys.EventArgs{constructor(){super()}}Object(h.a)(Nb,"SetPolicyLabelTriggeredEventArgs",Sys.EventArgs,[]);class Aa extends Sys.EventArgs{constructor(Ta){super();
this.WLk=Ta}}Object(h.a)(Aa,"UDPLabelingAppHandlerEventArgs",Sys.EventArgs,[]);var Ub=a(1355),Db=a(125),Ib=a(97),yc=a(47),xc=a(59),zb=a(1354),vb=a(245);class bb{static BDk(Ta,Hb){if(!Ta||!Hb||Ta.count!==Hb.count)return!1;for(const uc of Ta)if(!Hb.contains(uc))return!1;return!0}static toArray(Ta){if(!Ta)return null;const Hb=Array(Ta.count);let uc=0;for(const Sc of Ta)Hb[uc]=Sc,uc++;return Hb}}Object(h.a)(bb,"HashSetUtils",null,[]);var La=a(225),pb=a(89);class fa{constructor(Ta,Hb,uc,Sc=0,bc=null){this.v$c=
this.dLe=null;this.AFa=this.WCb=this.YCb=0;this.iSa="";this.CUa=this.$7c=this.DOe=this.zDa=this.Dfd=null;this.ePe=!1;this.Y7c=this.S5f=null;this.icd=0;this.Aic=this.EUa=this.oTa=this.zic=null;this.hh=new oa.a;this.X7b=this.sSb=this.kw=null;this.ddd=!1;this.aX={};this.cFb={};this.$Yb=null;this.Ga=Ta;this.Yn=Hb;this.Io=uc;this.yhc=Sc;this.Nn=new ab.a;this.s3g();this.bVe=this.Ga.Ya("PolicyHandlerEndpointName")||"PolicyHandler.ashx";this.i_=bc;this.iGc=Ta.ka("WacApplyManualPolicyLabelIsEnabled");this.yGc=
Ta.ka("CoAuthForProtectedFilesIsEnabled");this.supportsOfficeClientCoauthoring=Ta.ka("SupportsOfficeClientCoauthoring");this.krj=!1;this.VFk=3E4;this.vk=Ib.TaskManager.instance;Ta.ka("SupportsPolicies")&&ea.a("MipSupportsPolicies");this.yGc&&this.supportsOfficeClientCoauthoring&&ea.a("MipSupportsOfficeClientCoauthoring")}get jXf(){return this.ddd}get mC(){var Ta,Hb;return this.$x()?null!==(Hb=null===(Ta=this.Nn)||void 0===Ta?void 0:Ta.AppliedPolicyId)&&void 0!==Hb?Hb:"":this.iSa}get q8i(){if(this.$x()){let Ta=
0;for(const Hb of this.Nn.SensitivityLabels)Hb&&Hb.Enabled&&(Ta=Math.max(Ta,Hb.Order));return Ta}return this.icd}z7b(Ta){this.Nn.AppliedPolicyId=Ta;const Hb=this.Ga.appSettings;Hb&&(Hb.AppliedPolicyId=Ta)}get tfb(){var Ta,Hb,uc,Sc;if(this.$x()){const bc=this.mC;return bc?this.$x()?null!==(Hb=null===(Ta=this.aX[bc])||void 0===Ta?void 0:Ta.Order)&&void 0!==Hb?Hb:null:null!==(Sc=null===(uc=this.Klb(bc))||void 0===uc?void 0:uc.Order)&&void 0!==Sc?Sc:null:null}return this.Y7c}$wb(Ta){this.$x()||(this.Nn.AppliedPolicyId=
Ta,this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.ClpSetCachedAppliedLabelId",!1)&&(this.iSa=Ta,this.s6g()))}N4e(Ta){this.hh.addHandler("PolicyTipEvent",Ta)}bIb(Ta){this.hh.addHandler("LabelInfoUpdateEvent",Ta)}jnk(Ta){this.hh.removeHandler("LabelInfoUpdateEvent",Ta)}X4e(Ta){this.hh.addHandler("SetPolicyLabelEventKey",Ta)}Cok(Ta){this.hh.removeHandler("SetPolicyLabelEventKey",Ta)}Wpd(Ta){this.hh.addHandler("SetPolicyLabelFailureEventKey",Ta)}Bok(Ta){this.hh.removeHandler("SetPolicyLabelFailureEventKey",
Ta)}zCh(Ta){this.hh.addHandler("GetPolicyLabelEventKey",Ta)}yCh(Ta){this.hh.addHandler("GetPolicyLabelFailureEventKey",Ta)}wCh(Ta){this.hh.addHandler("GetAutoPolicyLabelEventKey",Ta);this.jXf&&(E.ULS.sendTraceTag(51668058,306,15,"GetAutoPolicyLabelHandler was registered after the AutoPolicyLabelHandlerEvent was raised"),this.Bfe(new sa(0)))}Hmk(Ta){this.hh.removeHandler("GetAutoPolicyLabelEventKey",Ta)}SBh(Ta){this.hh.addHandler("CreateAutoCLPSecurityNodesEventKey",Ta)}imk(Ta){this.hh.removeHandler("CreateAutoCLPSecurityNodesEventKey",
Ta)}TEh(Ta){this.hh.addHandler("UpdateAutoCLPLabelPriorityNodeEventKey",Ta)}Nok(Ta){this.hh.removeHandler("UpdateAutoCLPLabelPriorityNodeEventKey",Ta)}UEh(Ta){this.hh.addHandler("UpdateAutoCLPSITNodesEventKey",Ta)}Ook(Ta){this.hh.removeHandler("UpdateAutoCLPSITNodesEventKey",Ta)}G3e(Ta){this.hh.addHandler("AddAutoPolicyBusinessBarEntryEventKey",Ta)}vlk(Ta){this.hh.removeHandler("AddAutoPolicyBusinessBarEntryEventKey",Ta)}O4e(Ta){this.hh.addHandler("RemoveAutoPolicyBusinessBarEntryEventKey",Ta)}gok(Ta){this.hh.removeHandler("RemoveAutoPolicyBusinessBarEntryEventKey",
Ta)}H3e(Ta){this.hh.addHandler("AddMandatoryLabellingBusinessBarEntryEventKey",Ta)}xlk(Ta){this.hh.removeHandler("AddMandatoryLabellingBusinessBarEntryEventKey",Ta)}P4e(Ta){this.hh.addHandler("RemoveMandatoryLabellingBusinessBarEntryEventKey",Ta)}hok(Ta){this.hh.removeHandler("RemoveMandatoryLabellingBusinessBarEntryEventKey",Ta)}lDh(Ta){this.hh.addHandler("MandatoryLabellingAppHandlerEventKey",Ta)}snk(Ta){this.hh.removeHandler("MandatoryLabellingAppHandlerEventKey",Ta)}REh(Ta){this.hh.addHandler("UDPLabelingAppHandlerEventKey",
Ta)}Mok(Ta){this.hh.removeHandler("UDPLabelingAppHandlerEventKey",Ta)}AEk(){this.aX={};for(const Ta of this.Nn.SensitivityLabels)this.aX[Ta.Id]=Ta}MFk(){this.cFb={};for(const Ta of this.Nn.SensitivityLabels)Ta.ParentId||(this.cFb[Ta.Id]=new J.a);for(const Ta of this.Nn.SensitivityLabels)Ta.ParentId&&Ta.ParentId in this.cFb&&(this.aX[Ta.ParentId]&&(Ta.ParentName=this.aX[Ta.ParentId].DisplayName),Ta.Enabled&&this.cFb[Ta.ParentId].add(Ta.Id))}get wWd(){if(!this.dLe)return!1;for(const Ta of this.dLe.Iml())if(!Ta.Capabilities||
!Ta.Capabilities.SupportsClientIsMipTrusted)return!1;return!0}get Dqj(){return!!this.kw}qWh(){return this.DOe?this.DOe():!1}mhk(Ta){this.$7c=Ta}SF(){return(new Date).getTime()}C6(){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableSensitivityLabelingInOfficeJS",!1)}JAc(){this.Io&&(this.zic=this.Io.Li("WebServiceCall","Call Get Policy Endpoint On Server"));var Ta=La.a.xva(1,1);const Hb={["X-UsePFTPOP"]:this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.WACAADTokenInPolicyHandlerIsEnabled",
!1)?"1":"0"};this.Ga.ka("SendHostAttributionInfoForPolicyLabelEnabled")?(Ta=new zb.a(this.s3b("datalosspolicy"),1,null,Hb,!0,2,null,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,Ta),this.Yn.send(Ta).nhe(Object(K.a)(this,this.jjg,"onDataLossPolicySuccessCallback"),Object(K.a)(this,this.ijg,"onDataLossPolicyFailureCallback"))):this.Yn.ov(this.s3b("datalosspolicy"),1,null,Hb,!0,2,Object(K.a)(this,this.jjg,"onDataLossPolicySuccessCallback"),Object(K.a)(this,this.ijg,
"onDataLossPolicyFailureCallback"),null);this.YCb++;E.ULS.sendTraceTag(25565151,306,50,"Policy request is sent to server. The endpoint used is {0}. Policy call times: {1}.",this.bVe,this.YCb)}Vgk(){this.xRb(this.mC,2,this.zDa)}xRb(Ta,Hb=0,uc=null,Sc=!1,bc=null){fb.Health.instance.recordKpiUsage("MipGetPolicyLabel",Ea.b.FailureBased,"officewebclp",this.BLd(void 0,Hb));this.sSb=this.SF();const vc=this.Azd(Hb);this.IAc(Ta,vc,uc,Sc,Hb,bc);this.bke(!0)}s3g(){const Ta=Object(Ja.b)();if(this.zPe=!!Ta)this.Nn=
Ta}v1f(){this.s3g();return this.zPe}jjg(Ta){this.kvg();let Hb="";({data:Hb}=this.Dye(Ta)).returnValue&&(E.ULS.sendTraceTag(25565153,306,50,"Request to get DataLossPrevention policy succeeded."),this.YCb=0,this.Io&&(this.Aic=this.Io.Li("Task","Parse and Handle Get Policy Response")),this.y4j(Hb),this.Aic&&(this.Aic.stop(),this.Aic=null))}ijg(Ta){this.kvg();this.YCb<=this.yhc?this.JAc():(E.ULS.sendTraceTag(25565154,306,15,"Request to get DataLossPrevention policy failed with error response: {0}.",Ta?
Ta.data?Ta.data.g7a:null:null),this.YCb=0)}N2f(){return 0<this.AFa}PYc(Ta,Hb,uc=null,Sc=null){const bc=this.Bzd(uc),vc=this.$x()?this.mC:"";this.$x()&&this.z7b(Ta);this.Npe(Ta,Hb,bc,uc,Sc,vc)}yqg(Ta,Hb){this.EUa&&(this.EUa.stop(),this.EUa=null);const {OMg:uc,CQg:Sc,aF:bc}=this.LLf(Ta),vc=Ta.data.state,Xc=vc?vc.AX:2;let ad="";({data:ad}=this.Dye(Ta)).returnValue?(E.ULS.sendTraceTag(41799707,306,50,"Request to set label policy data succeeded. ApplyLabelFlag: {0}",Xc),this.AFa=0,this.T4j(ad,uc,Sc,vc,
bc,Hb)):this.$le(Xc,bc,0,Hb)}xdk(Ta){fb.Health.instance.recordKpiUsage("MipSetPolicyLabel",Ea.b.FailureBased,"officewebclp",this.BLd(Ta));this.X7b=this.SF();E.ULS.sendTraceTag(575947405,306,50,"Raising set policy label triggered event.");this.hh.raiseEvent("SetPolicyLabelTriggeredEventKey",new Nb(Ta))}bLj(){this.yGc&&this.supportsOfficeClientCoauthoring&&this.Dqj&&this.kw.$ia(12,null,!0)}xqg(Ta,Hb){this.EUa&&(this.EUa.stop(),this.EUa=null);const {OMg:uc,CQg:Sc,aF:bc}=this.LLf(Ta);if(this.AFa<=this.yhc)this.$x()?
this.Npe(uc,Sc,this.Bzd(null),null,bc,Hb):this.PYc(uc,Sc,null,bc);else{var vc=Ta.data.state;vc=vc?vc.AX:2;E.ULS.sendTraceTag(41799708,306,15,"Request to set label policy failed with error response: {0}. ApplyLabelFlag: {1}",Ta?Ta.data?Ta.data.g7a:null:null,vc);this.$Yb="WACServerConnectionFailed";this.AFa=0;this.$le(vc,bc,0,Hb)}}oqj(Ta){if(Ta&&("LabelNotSupported"===Ta||"LabelErrorRetryLater"===Ta||"CoherencyFailure"===Ta||"LabelIdNotFound"===Ta||"LabelDisabled"===Ta))return E.ULS.sendTraceTag(539103556,
306,50,"LabelError is retriable: {0}",Ta),!0;E.ULS.sendTraceTag(539103557,306,50,"LabelError is not retriable: {0}",Ta);return!1}Doa(Ta){return Ta.IsEndpointProtectionEnabled||Ta.HasUserDefinedPermissions}oWd(Ta){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?"Microsoft FTE"===Ta.DisplayName:Ta.AppliesDynamicWatermarking}oLd(Ta){return this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarkingMockDWLabel",!1)?
"Watermark Text":Ta.DynamicWatermarkingText}KTh(Ta){if(!Ta)return!1;let Hb=null,uc=null;if(this.$x())Hb=this.aX[Ta],uc=this.aX[this.mC];else for(const Sc of this.Nn.SensitivityLabels)Sc.Id===Ta&&(Hb=Sc),Sc.Id===this.mC&&(uc=Sc);if(!Hb)return!1;if(this.yGc&&this.supportsOfficeClientCoauthoring){if(this.$7c&&this.$7c()||this.wWd)return!0}else if(r.AFrameworkApplication.FI&&r.AFrameworkApplication.FI.XQb||this.zDa&&this.zDa())return!0;return this.Doa(Hb)===(!!uc&&this.Doa(uc))}xHb(Ta,Hb,uc,Sc,bc){28===
Ta?this.gzg(new Jb(Ta,Hb,uc,Sc,bc,!1)):this.gzg(new Jb(Ta,Hb,uc,Sc,bc,!0))}oqa(Ta){28===Ta?this.Rzg(new Hc(Ta,!1)):this.Rzg(new Hc(Ta,!0))}vck(Ta,Hb,uc){E.ULS.sendTraceTag(545280777,306,50,"Raising a CreateAutoCLPSecurityNodes event.");this.hh.raiseEvent("CreateAutoCLPSecurityNodesEventKey",new nb(Ta,Hb,uc))}Ddk(Ta){E.ULS.sendTraceTag(545280778,306,50,"Raising a UpdateAutoCLPLabelPriorityNode event.");this.hh.raiseEvent("UpdateAutoCLPLabelPriorityNodeEventKey",new nb(null,null,Ta))}Edk(Ta,Hb){E.ULS.sendTraceTag(545280779,
306,50,"Raising a UpdateAutoCLPSITNodes event.");this.hh.raiseEvent("UpdateAutoCLPSITNodesEventKey",new nb(Ta,Hb,null))}Czg(Ta,Hb){E.ULS.sendTraceTag(572650527,306,50,"Raising a mandatory labelling"+(1===Hb?"Reading":"Edit")+" switch event.");this.hh.raiseEvent("MandatoryLabellingAppHandlerEventKey",new hb(Ta,Hb))}tod(Ta,Hb,uc,Sc,bc){37===Ta&&this.lck(new $a(37,Hb,uc,Sc,bc))}qie(){this.pdk(new bd)}Cdk(){E.ULS.sendTraceTag(540608322,306,50,"Raising a UDP labeling event.");this.hh.raiseEvent("UDPLabelingAppHandlerEventKey",
new Aa(!0))}Lea(Ta=!1){const Hb=Object(Ub.a)(this.Nn);Hb||Ta||Ca.GVc(!1);return Hb}eAk(){window.postMessage(JSON.stringify({type:"mipProperties",isProtected:r.AFrameworkApplication.protectedFile,sensitivity:{labelId:this.mC},usageRights:{docEdit:this.Nn.EditEnabled,extract:r.AFrameworkApplication.enableExtractForProtectedFile,print:r.AFrameworkApplication.printingEnabled,export:r.AFrameworkApplication.vjb,objModel:r.AFrameworkApplication.enableMacrosForProtectedFile,owner:r.AFrameworkApplication.wjb}}),
"*")}N7j(){E.ULS.shipAssertTag(507888257,306,this.v1f(),"populatePolicyLabelsDataFromCache was called with no cached response");Object(Ja.c)()?(E.ULS.sendTraceTag(507847580,306,50,"Policy label boot call is still pending response."),Object(Ja.e)(this.AUf.bind(this))):(E.ULS.sendTraceTag(507847579,306,50,"Policy label boot call is being used to populate policy label info"),this.AUf())}AUf(){this.DUf(Object(Ja.b)(),Object(Ja.a)());this.wzg(1,!0)}wzg(Ta,Hb){this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",
!1)&&this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableEdgeBlockScreenCapture",!1)&&Hb&&this.eAk();fb.Health.instance.recordKpiSuccess("MipGetPolicyLabel",this.Izc(void 0,Ta,this.sSb));this.sSb=null;Ta=new sa(Ta);this.Gck(Ta);Hb&&this.zKk()?(this.jXf?this.J6k(this.S5f!==this.tfb):(this.Bfe(Ta),this.ddd=!0),this.$x()&&(this.S5f=this.tfb),this.$x()||(this.Bfe(Ta),this.ddd=!0)):Hb||this.Cfe()}Z9d(Ta){this.oTa&&(this.oTa.stop(),this.oTa=null);var Hb=null;Ta&&Ta.data&&(Hb=Ta.data.aF);
let uc;this.bke(!1);({data:uc}=this.Dye(Ta)).returnValue?(E.ULS.sendTraceTag(34996493,306,50,"Request to get label policy data succeeded."),this.WCb=0,Hb=this.G4j(uc,Hb),this.wzg(this.rKf(Ta.data),Hb)):this.Cfe()}zKk(){if(!this.Ga.ka("WacApplyManualPolicyLabelIsEnabled"))return E.ULS.sendTraceTag(539877667,306,50,"ShouldAutoClassificationRun returned false - Manual Labeling is not enabled"),!1;if(!this.mJh())return!1;if(""===this.mC)return E.ULS.sendTraceTag(539877696,306,50,"ShouldAutoClassificationRun returned true - document is not labeled"),
!0;if(this.tfb===this.q8i)return E.ULS.sendTraceTag(539877697,306,50,"ShouldAutoClassificationRun returned false - Applied label already has the highest priority"),!1;E.ULS.sendTraceTag(539877698,306,50,"ShouldAutoClassificationRun returned true - document is labeled but not with the highest priority label");return!0}atc(){this.e5g();E.ULS.sendTraceTag(545104324,306,50,"Creating AutoCLP Security nodes. HasSITs: {0}, LabelPriority: {1}",0<this.CUa.count,this.tfb);const Ta=bb.toArray(this.CUa);this.vck(Ta,
Ta,this.tfb)}J6k(Ta){var Hb=this.CUa;this.e5g();bb.BDk(Hb,this.CUa)||(E.ULS.sendTraceTag(545104325,306,50,"Updating AutoCLP SIT nodes. HasSITs: {0}",0<this.CUa.count),Hb=bb.toArray(this.CUa),this.Edk(Hb,Hb));Hb=this.tfb;if(this.$x()?Ta:this.ePe)E.ULS.sendTraceTag(545104326,306,50,"Updating AutoCLP Label Priority node. LabelPriority: {0}",Hb),this.Ddk(Hb)}e5g(){var Ta;const Hb=new Va.a(L.a.zm());for(const uc of this.Nn.SensitivityLabels)if(0<(null===(Ta=null===uc||void 0===uc?void 0:uc.AutoLabelingSensitiveTypeIds)||
void 0===Ta?void 0:Ta.length))for(const Sc of uc.AutoLabelingSensitiveTypeIds)Sc&&Hb.add(Sc);this.CUa=Hb}Y9d(Ta){const Hb=this.rKf(Ta.data);let uc=null;Ta&&Ta.data&&(uc=Ta.data.aF);fb.Health.instance.recordKpiFailure("MipGetPolicyLabel","GetPolicyLabelsFailure",!1,!1,this.Izc(void 0,Hb,this.sSb));this.sSb=null;this.oTa&&(this.oTa.stop(),this.oTa=null);if(this.WCb<=this.yhc){if(this.Ga.ka("SendHostAttributionInfoForPolicyLabelEnabled")){const Sc=Ta.data.request.get_headers();if("HostAttributionInfo.ScenarioParamName"in
Sc&&Sc[La.a.eXc]&&"HostAttributionInfo.ScenarioTypeParamName"in Sc&&Sc[La.a.G6b]){Ta.data.request.get_headers();Ta.data.request.get_headers()[La.a.G6b];Ta=this.Azd(Hb);this.IAc(this.mC,Ta,this.zDa,void 0,Hb,uc);return}}this.xRb(this.mC,Hb,this.zDa,!1,uc)}else E.ULS.sendTraceTag(34996494,306,15,"Request to get label policy failed with error response: {0}.",Ta?Ta.data?Ta.data.g7a:null:null),this.Cfe(),this.WCb=0,this.bke(!1)}rKf(Ta){return Ta.state?Ta.state:0}s3b(Ta,Hb=!1){return Object(Ub.c)(this.Ga.Ya("PolicyHandlerWebServiceBase")||
r.AFrameworkApplication.ra.$g.H1,this.bVe,r.AFrameworkApplication.Jo,Ta===Ub.e&&r.AFrameworkApplication.FI&&r.AFrameworkApplication.FI.rZf,Ta,Hb)}LLf(Ta){let Hb=null,uc=null,Sc=null;Ta&&Ta.data&&Ta.data.request&&Ta.data.request.get_headers()&&(Hb=Ta.data.request.get_headers()[pb.a.PMg],uc=Ta.data.request.get_headers()[pb.a.DQg],Sc=Ta.data.aF);return{OMg:Hb,CQg:uc,aF:Sc}}Dye(Ta){Ta=Ta?Ta.data?Ta.data.responseData:null:null;return Ta&&Ta.length&&!this.grj(Ta)?{returnValue:!0,data:Ta}:(E.ULS.sendTraceTag(25565152,
306,10,"No response data from policy endpoint."),{returnValue:!1,data:Ta})}y4j(Ta){let Hb;try{Hb=yc.b(Ta)}catch(uc){E.ULS.sendTraceTag(37880331,306,10,"Error when deserializing DataLossPrevention response.");return}if(Hb)if(Hb.IsPolicyTipAvailable)switch(Hb.IsPolicyTipAvailable.toLowerCase()){case "false":E.ULS.sendTraceTag(26007261,306,50,"policyData.IsPolicyTipAvailable is false so DLP policy tip is not present.");break;case "true":E.ULS.sendTraceTag(25565186,306,50,"DLP Policy is enabled on this document.");
this.v$c=Hb.NavigateUrl;this.FQk(Hb.GeneralText,Object(K.a)(this,this.AQj,"onDataLossPolicyOverrideButtonClick"));break;default:E.ULS.sendTraceTag(26007262,306,10,"policyData.IsPolicyTipAvailable is expected to be 'true' or 'false' but it is {0}",Hb.IsPolicyTipAvailable)}else E.ULS.sendTraceTag(26007260,306,10,"policyData.IsPolicyTipAvailable is null or empty whereas it should be 'true' or 'false'.");else E.ULS.sendTraceTag(25565185,306,10,"policyData is null after deserializing DataLossPrevention response.")}Z2h(Ta){switch(Ta){case "CoherencyFailure":return 1;
case "DisabledByPolicy":return 2;case "FileCheckedOut":return 3;case "FileEncrypted":return 4;case "FileLocked":return 5;case "FileNotSupported":return 6;case "FileTooLarge":return 7;case "InvalidOperationOnZeroByteFile":return 8;case "LabelDisabled":return 9;case "LabelErrorRetryLater":return 10;case "LabelIdNotFound":return 11;case "LabelIrmDisabledByTenant":return 12;case "LabelNotSupported":return 13;case "MinorVersionLimitExceeded":return 15;default:return 0}}T4j(Ta,Hb,uc,Sc,bc,vc){var Xc=Sc?
Sc.AX:2;let ad=0;var Id="";let ue;if(({zz:ue}=yc.d(Ta)).returnValue)if(ue){Id="Success";Ta=this.Azd(3);if(ue.IsSuccessful){fb.Health.instance.recordKpiSuccess("MipSetPolicyLabel",this.Izc(Xc,void 0,this.X7b));this.$Yb=this.X7b=null;E.ULS.sendTraceTag(51233632,306,50,"setPolicyLabel was successful as seen after deserializing set policy label data response. ApplyLabelFlag: {0}",Xc);2===Xc&&this.oqa(29);this.SGk(Hb,Xc);this.bLj();this.oqa(28);this.C6()?Sc&&4===Xc&&(Id=bc.startsWith("OFFICEJS_SENSITIVITY_CONTEXT_"),
this.xHb(28,Id?"SENSITIVITY":Object(U.a)("PolicyBusinessBarTitle"),String.format(Id?"Due to content created by Copilot, your organization automatically applied the sensitivity label: {0}.":Object(U.a)("PolicyLabelAutomaticallyAppliedMessage"),Sc.displayName),Object(U.a)("DialogOk"),()=>{})):Sc&&4===Xc&&this.xHb(28,Object(U.a)("PolicyBusinessBarTitle"),String.format(Object(U.a)("PolicyLabelAutomaticallyAppliedMessage"),Sc.displayName),Object(U.a)("DialogOk"),()=>{});ea.a("MipAppliedLabels",void 0,
void 0,[{name:"SetPolicyLabelApplyFlag",string:Ka[Xc]}]);this.IAc(Hb,Ta,this.zDa,void 0,3,bc);return}E.ULS.sendTraceTag(51233631,306,10,"setPolicyLabel was unsuccessful as seen after deserializing set policy label data response. ApplyLabelFlag: {0}, FailureReason: {1}",Xc,ue.FailureReason);this.$Yb=ue.FailureReason;ad=this.Z2h(ue.FailureReason);this.krj&&0<=ue.FailureReason.indexOf("InvalidOperationOnZeroByteFile")&&(Sc=new Db.a(2,1,this.VFk,()=>{E.ULS.sendTraceTag(575428443,306,15,"Retring SetPolicyLabelRequestAsync as previous called failed due to zero byte. Attempt number : {0}",
this.AFa);this.AFa<=this.yhc&&(this.$x()?this.Npe(Hb,uc,this.Bzd(null),null,bc,vc):this.PYc(Hb,uc,null,bc))}),this.vk.jm(Sc));this.yGc&&this.supportsOfficeClientCoauthoring&&this.IAc(this.Nn.AppliedPolicyId,Ta,this.zDa,!0,3,bc)}else Id="setPolicyLabelData null.",E.ULS.sendTraceTag(42467541,306,10,"setPolicyLabelData is null after deserializing set policy label data response. ApplyLabelFlag: {0}",Xc);else Id="TryDeserialize failed.",E.ULS.sendTraceTag(41799709,306,10,"Error when deserializing set policy label data response. ApplyLabelFlag: {0}",
Xc);this.$le(Xc,bc,ad,vc);Xc=this.Izc(Xc,void 0,this.X7b);this.X7b=null;Xc.extendedProperties.set("SetPolicyLabelDataFailureReason",this.$Yb);Xc.extendedProperties.set("SetPolicyLabelDataParseStatus",Id.toString());fb.Health.instance.recordKpiFailure("MipSetPolicyLabel","SetPolicyLabelFailure",!1,!1,Xc)}Klb(Ta){if(""===Ta)return null;for(const Hb of this.Nn.SensitivityLabels)if((null===Hb||void 0===Hb?void 0:Hb.Id)===Ta)return Hb;return null}a5g(){if(""!==this.mC)if(this.$x()){var Ta=this.aX[this.mC];
Ta&&(Ta.HasExtractForUser=this.Doa(Ta)?this.Nn.ExtractEnabled:!0)}else for(Ta of this.Nn.SensitivityLabels)(null===Ta||void 0===Ta?void 0:Ta.Id)===this.mC&&(Ta.HasExtractForUser=this.Doa(Ta)?this.Nn.ExtractEnabled:!0)}$le(Ta,Hb,uc,Sc){E.ULS.sendTraceTag(507576852,306,50,"revertAppliedPolicyId called. ErrorType: {0}",uc);const bc=2===Ta||8===Ta||16===Ta,vc=new Pa;this.$x()?this.z7b(Sc):this.$wb(this.iSa);this.C6()&&(this.$x()||(vc.aoc=this.Klb(this.mC)),vc.context=Hb,vc.BQg=uc);this.zzg(vc);this.Mfe(uc,
Ta,bc,!1)}SGk(Ta,Hb){this.$x()?this.z7b(Ta):this.$wb(this.iSa=Ta);if(!this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1))if(""===Ta)r.AFrameworkApplication.protectedFile=!1,r.AFrameworkApplication.enableMacrosForProtectedFile=!1;else for(const uc of this.Nn.SensitivityLabels)if(uc.Id===Ta){r.AFrameworkApplication.protectedFile=this.Doa(uc);break}this.wdk(new zc(Ta,Hb))}s6g(){if(!this.$x())for(const Ta of this.Nn.SensitivityLabels)if(null===Ta||void 0===
Ta?0:Ta.Enabled)Ta.Id===this.iSa&&(this.ePe=this.Y7c!==Ta.Order,this.Y7c=Ta.Order),Ta.Order>this.icd&&(this.icd=Ta.Order)}N6g(){var Ta=this.mC;this.Ga.appSettings&&(this.$x()?this.Ga.appSettings.AppliedPolicyId=Ta:this.Ga.appSettings.AppliedPolicyId=this.mC);var Hb=!1;if(this.$x())Ta&&(Ta=this.aX[Ta])&&(Hb=this.Doa(Ta));else if(""!==this.mC)for(var uc of this.Nn.SensitivityLabels)if(uc.Id===this.mC){Hb=this.Doa(uc);break}if(this.$x())if(r.AFrameworkApplication.protectedFile=Hb){Hb=this.Nn.EditEnabled;
Ta=this.Nn.PrintEnabled;uc=this.Nn.MacrosEnabled;const Sc=this.Nn.ExtractEnabled,bc=this.Nn.ExportEnabled,vc=this.Nn.FullControlEnabled;r.AFrameworkApplication.EAa=this.Nn.ViewEnabled&&!Hb;r.AFrameworkApplication.printingEnabled=Ta;r.AFrameworkApplication.enableMacrosForProtectedFile=uc;r.AFrameworkApplication.enableExtractForProtectedFile=Sc;r.AFrameworkApplication.vjb=bc;r.AFrameworkApplication.wjb=vc}else r.AFrameworkApplication.EAa=!1,r.AFrameworkApplication.printingEnabled=!1,r.AFrameworkApplication.enableMacrosForProtectedFile=
!1,r.AFrameworkApplication.enableExtractForProtectedFile=!1,r.AFrameworkApplication.vjb=!1,r.AFrameworkApplication.wjb=!1;else r.AFrameworkApplication.protectedFile=Hb,r.AFrameworkApplication.EAa=Hb?this.Nn.ViewEnabled&&!this.Nn.EditEnabled:!1,r.AFrameworkApplication.printingEnabled=Hb?this.Nn.PrintEnabled:!1,r.AFrameworkApplication.enableMacrosForProtectedFile=Hb?this.Nn.MacrosEnabled:!1,r.AFrameworkApplication.enableExtractForProtectedFile=Hb?this.Nn.ExtractEnabled:!1,r.AFrameworkApplication.vjb=
Hb?this.Nn.ExportEnabled:!1,r.AFrameworkApplication.wjb=Hb?this.Nn.FullControlEnabled:!1}DUf(Ta,Hb){if(!Ta)return E.ULS.sendTraceTag(42467542,306,10,"policyData is null after deserializing label policy data response."),!1;if(!Ta.AreLabelsAvailable)return!1;this.Nn=Ta;this.$x()?this.z7b(Ta.AppliedPolicyId):this.iSa=Ta.AppliedPolicyId;this.C6()&&(this.$x()||this.a5g());this.Ga.getBooleanFeatureGate("Microsoft.Office.SharedOnline.UpdateIRMWhenLabelChangedEnabled",!1)?this.$x()||this.N6g():this.Ga.appSettings&&
(this.Ga.appSettings.AppliedPolicyId=this.mC);this.s6g();this.Lea()&&E.ULS.sendTraceTag(51197846,306,50,"Labels are available for display after GetPolicyLabels call.");Ta=new Pa(!0);this.C6()&&(this.$x()||(Ta.aoc=this.Klb(this.mC)),Ta.context=Hb);this.zzg(Ta);return!0}G4j(Ta,Hb=null){return({zz:Ta}=yc.d(Ta)).returnValue?this.DUf(Ta,Hb):(E.ULS.sendTraceTag(34996495,306,10,"Error when deserializing label policy data response."),!1)}mJh(){var Ta;if(!this.Lea())return E.ULS.sendTraceTag(539877699,306,
50,"AreAutoLabelingSensitiveTypesAvailable returned false - No labels to display"),!1;for(const Hb of this.Nn.SensitivityLabels)if(0<(null===(Ta=null===Hb||void 0===Hb?void 0:Hb.AutoLabelingSensitiveTypeIds)||void 0===Ta?void 0:Ta.length))return!0;E.ULS.sendTraceTag(539877700,306,50,"AreAutoLabelingSensitiveTypesAvailable returned false - No labels with AutoClp SIT");return!1}zzg(Ta){E.ULS.sendTraceTag(35393610,306,50,"Raising label info update event.");this.$x()&&(this.AEk(),this.MFk(),this.N6g(),
this.C6()&&this.a5g(),Ta.aoc=this.aX[this.mC]);this.hh.raiseEvent("LabelInfoUpdateEvent",Ta)}Gck(Ta){E.ULS.sendTraceTag(50676305,306,50,"Raising get policy label event.");this.hh.raiseEvent("GetPolicyLabelEventKey",Ta)}Cfe(){Ca.GVc(!1);this.hh.raiseEvent("GetPolicyLabelFailureEventKey",new na)}Bfe(Ta){this.i_&&this.i_.execute(Hb=>{Hb=[Hb.isFeatureEnabled("MsoClpSpTwo",!0),Hb.isFeatureEnabled("MsoDrmPremiumSpTwo",!0)];Promise.all(Hb).then(uc=>{vb.a.any(uc,Sc=>Sc)&&(E.ULS.sendTraceTag(50944077,306,
50,"Raising get auto policy label event."),this.hh.raiseEvent("GetAutoPolicyLabelEventKey",Ta),this.atc(),ea.a("MipAutoClassificationEnabled"));return null})})}BLd(Ta=null,Hb=null){const uc=new Map;uc.set("ClpCoauth",this.supportsOfficeClientCoauthoring.toString());null!=Ta&&uc.set("ApplyLabelFlags",Ka[Ta]);null!=Hb&&uc.set("GetPolicyLabelsReason",wa[Hb]);return uc}Izc(Ta=null,Hb=null,uc=null){const Sc={};Sc.extendedProperties=this.BLd(Ta,Hb);null!=uc&&(Sc.durationMs=this.SF()-uc);return Sc}wdk(Ta){E.ULS.sendTraceTag(41799710,
306,50,"Raising set policy label event.");this.hh.raiseEvent("SetPolicyLabelEventKey",Ta)}gzg(Ta){E.ULS.sendTraceTag(51128227,306,50,"Raising an add auto policy business bar entry event.");Ta&&Ta.qXb&&ea.a("MipRecommendations");this.hh.raiseEvent("AddAutoPolicyBusinessBarEntryEventKey",Ta)}Rzg(Ta){E.ULS.sendTraceTag(51128256,306,50,"Raising an remove auto policy business bar entry event.");this.hh.raiseEvent("RemoveAutoPolicyBusinessBarEntryEventKey",Ta)}lck(Ta){E.ULS.sendTraceTag(573842331,306,50,
"Raising an add mandatory labelling business bar entry event.");this.hh.raiseEvent("AddMandatoryLabellingBusinessBarEntryEventKey",Ta)}pdk(Ta){E.ULS.sendTraceTag(573842332,306,50,"Raising a remove mandatory labelling business bar entry event.");this.hh.raiseEvent("RemoveMandatoryLabellingBusinessBarEntryEventKey",Ta)}FQk(Ta,Hb=null){E.ULS.sendTraceTag(34996496,306,50,"Showing policy tip to user.");this.hh.raiseEvent("PolicyTipEvent",new ac(Object(U.a)("PolicyBusinessBarTitle"),Ta,Object(U.a)("PolicyOverrideButton"),
Hb))}Mfe(Ta,Hb,uc,Sc=!0){E.ULS.sendTraceTag(42074656,306,Sc?50:15,"Raising set policy label failure event. ApplyLabelFlags: {0}",Hb);Sc=Object(U.a)("SensitivityApplicationErrorBusinessBarTitle");let bc=Object(U.a)("SensitivityApplicationErrorBusinessBarMessage"),vc=null,Xc=null;switch(Ta){case 2:Sc=Object(U.a)("SensitivityApplicationErrorDisabledByPolicyBusinessBarTitle");bc=Object(U.a)("SensitivityApplicationErrorDisabledByPolicyBusinessBarMessage");break;case 5:bc=Object(U.a)("SensitivityApplicationErrorFileLockedBusinessBarMessage");
break;case 7:Sc=Object(U.a)("SensitivityApplicationErrorFileTooLargeBusinessBarTitle");bc=Object(U.a)("SensitivityApplicationErrorFileTooLargeBusinessBarMessage");break;case 13:Sc=Object(U.a)("SensitivityApplicationErrorLabelNotSupportedBusinessBarTitle");bc=Object(U.a)("SensitivityApplicationErrorLabelNotSupportedBusinessBarMessage");break;case 9:Sc=Object(U.a)("SensitivityApplicationErrorLabelDisabledBusinessBarTitle");bc=Object(U.a)("SensitivityApplicationErrorLabelDisabledBusinessBarMessage");
break;case 10:bc=Object(U.a)("SensitivityApplicationErrorLabelErrorRetryLaterBusinessBarMessage");break;case 14:Sc=Object(U.a)("SensitivityCoauthMandatoryApplicationErrorTitle");bc=Object(U.a)("SensitivityCoauthMandatoryApplicationErrorMessage");break;case 15:Sc=Object(U.a)("SensitivityApplicationErrorMinorVersionLimitReachedBusinessBarTitle"),bc=Object(U.a)("SensitivityApplicationErrorMinorVersionLimitReachedBusinessBarMessage"),vc=Object(U.a)("LearnMore"),Xc=()=>{this.WFk()}}Ta=new oc(Ta,Hb,uc,
Sc,bc,vc,Xc);this.hh.raiseEvent("SetPolicyLabelFailureEventKey",Ta)}fFk(Ta){this.Dfd=Ta}AQj(){this.v$c?(E.ULS.sendTraceTag(25565187,306,50,"DLP override button was clicked."),xc.a.H0(this.v$c)):E.ULS.sendTraceTag(25565188,306,10,"Null NavigateUrl got in policy response. Could not navigate to SPO.")}grj(Ta){if(!Ta.startsWith("<")||-1===Ta.indexOf("Error")&&-1===Ta.indexOf("Unavailable"))return!1;E.ULS.sendTraceTag(25565189,306,10,"The response from server is not a valid JSON response and it matches the error page keyword. This might be the error response from a non-existing endpoint.");
return!0}kvg(){this.zic&&(this.zic.stop(),this.zic=null)}MDi(Ta){if(!Ta)return"manual";switch(Ta.AX){case 0:return"manual";case 4:return"auto";case 1:return"default";case 16:return"mandatory";case 2:return"manual";case 8:return"recommended";case 32:return"ai";default:return"manual"}}XEi(Ta){if(!Ta)return"privileged";Ta=Ta.AX;let Hb="privileged";if(4===Ta||1===Ta||32===Ta)Hb="standard";return Hb}IAc(Ta,Hb,uc=null,Sc=!1,bc=0,vc=null){this.Ga.ka("WacLabelingGetPolicyLabelsIsEnabled")&&(this.$x()?this.z7b(Ta):
this.iSa=Ta,this.zDa=uc,this.Io&&(this.oTa=this.Io.Li("WebServiceCall","Call Get Policy Endpoint On Server")),Object(Ub.d)(this.Ga,this.Yn,Object(K.a)(this,this.Z9d,"onGetPolicyLabelsSuccessCallback"),Object(K.a)(this,this.Y9d,"onGetPolicyLabelsFailureCallback"),this.s3b("getpolicylabels",Sc),Ta,Hb,bc,vc),this.WCb++,E.ULS.sendTraceTag(34996492,306,50,"Policy label request sent to server. Policy call times: {0}",this.WCb))}Npe(Ta,Hb,uc,Sc,bc,vc){if(this.iGc){this.Io&&(this.EUa=this.Io.Li("WebServiceCall",
"Call Set Policy Endpoint On Server"));var Xc={};Xc[pb.a.PMg]=Ta;Hb&&(Xc[pb.a.DQg]=encodeURIComponent(Hb));this.Dfd&&(Xc[pb.a.IHh]=this.Dfd);Sc?(Xc[pb.a.zQg]=this.MDi(Sc),Xc[pb.a.AQg]=this.XEi(Sc),1===Sc.AX&&this.Nn.DefaultLabelType&&(Xc[pb.a.TFk]=this.Nn.DefaultLabelType)):(Xc[pb.a.zQg]="manual",Xc[pb.a.AQg]="privileged");this.supportsOfficeClientCoauthoring&&this.Nn&&(Xc[pb.a.W6j]=this.Nn.PolicyLabelVersionToken);this.Ga.ka("SendHostAttributionInfoForPolicyLabelEnabled")?(Ta=new zb.a(this.s3b(Ub.e,
!0),1,null,Xc,!0,2,Sc,void 0,this.C6()?bc:void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,uc),this.Yn.send(Ta).nhe(ad=>this.yqg(ad,vc),ad=>this.xqg(ad,vc))):this.Yn.ov(this.s3b(Ub.e,!0),1,null,Xc,!0,2,ad=>this.yqg(ad,vc),ad=>this.xqg(ad,vc),Sc,this.C6()?bc:void 0,void 0,void 0,void 0,"32");this.AFa++;E.ULS.sendTraceTag(41799706,306,50,"Set policy label request sent to server. Policy call times: {0}",this.AFa)}else E.ULS.sendTraceTag(570972052,306,50,"SetPolicyLabelRequestInternalAsync was exited - ApplyManualPolicyLabel was not enabled.")}WFk(){const Ta=
new ua.a,Hb=this.Ga.Ya("BreadcrumbFolderUrl");Hb?(Ta.Ph=11,Ta.ti(1,Object(U.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoAction")),Ta.ti(2,Object(U.a)("DialogOk"))):(Ta.Ph=0,Ta.ti(1,Object(U.a)("DialogOk")));Ta.B2e(Object(U.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoHelpText"),"0f6cd105-974f-44a4-aadb-43ac5bdfd247");Ta.skk();Ta.pW(Object(U.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoTitle"),Object(U.a)("SensitivityApplicationErrorMinorVersionLimitReachedViewInfoMessage"),
uc=>{1===uc&&Hb&&xc.a.Cm(Hb,"_blank",void 0,"SetPolicyLabelFailureBusinessBarActionCallback.BreadcrumbFolderUrl")})}Azd(Ta){return Object(Ub.b)(Ta)}Bzd(Ta=null){if(!Ta)return La.a.xva(8,0);switch(Ta.AX){case 1:case 16:return La.a.xva(1,1);case 4:case 2:case 8:return La.a.xva(8,1);default:return La.a.xva(8,0)}}bke(Ta){xa.c()&&appChrome.api.setAsyncRequestStatus("sensitivity",Ta)}xna(Ta){return Ta?Ta.ParentId&&Ta.ParentName?Ta.ParentName+"\\"+Ta.DisplayName:Ta.DisplayName:""}getHighestSensitivityLabel(Ta){if(!Ta||
0==Ta.length)return null;let Hb=null;for(const uc of Ta)if(""!==uc)if(this.$x())if(Ta=this.aX[uc]){if(!Hb||Ta.Order>Hb.Order)Hb=Ta}else return null;else{Ta=!1;for(const Sc of this.Nn.SensitivityLabels)(null===Sc||void 0===Sc?void 0:Sc.Id)===uc&&(Ta=!0,!Hb||Sc.Order>Hb.Order)&&(Hb=Sc);if(!Ta)return null}Hb||(Hb=new ia.a);return Hb}NEi(){if(""===this.mC)return[!0,new ia.a];if(this.Ga.ka("SupportsPolicies")){let Ta;Ta=this.$x()?this.aX[this.mC]:this.Klb(this.mC);return Ta?[!0,Ta]:(E.ULS.sendTraceTag(507557842,
306,10,"GetAppliedLabel couldn't find an applied label from policy"),[!1,2147205112])}return[!1,2147205115]}tryUpgradeLabel(Ta,Hb){if(""===Ta.Id)return 0;var uc=this.$x()?this.aX[this.mC]:this.Klb(this.mC);Ta=this.$x()?this.aX[Ta.Id]:this.Klb(Ta.Id);if(!Ta)return 2147205112;if(!Ta.Enabled)return 2147205117;if(Ta.HasUserDefinedPermissions)return 2147205116;if(1==r.AFrameworkApplication.yh.mode)return 2147205119;if(Ta.RequiredDowngradeJustification||(null===uc||void 0===uc?void 0:uc.Order)>=Ta.Order)return 2147205105;
uc=new Q(4,this.xna(Ta));this.PYc(Ta.Id,"",uc,Hb);return 0}$x(){return za(this.Ga)}}Object(h.a)(fa,"PolicyManager",null,[671]);var kb=a(145),db=a(282);class gb{constructor(){this.Ada=this.mFa=this.Wh=this.$l=null;this.Sgg=()=>{this.Ada=Object(k.a)();this.$l||(this.$l=B());this.mFa=v.a.instance.resolve("Common.App.Policy.PolicyActor");xa.a("isSharedUxGateEnabled")&&appChrome.api.isSharedUxGateEnabled("SharedOnline.ChangeGate.DelayPolicyActionRegistration")?this.$l.bIb(Object(K.a)(this.mFa,this.mFa.xCg,
"registerActionsHandler")):this.mFa.ho();this.$l.bIb(this.Wze);r.AFrameworkApplication.fa.ka("WacApplyManualPolicyLabelIsEnabled")&&(this.$l.Wpd(this.b5i),this.$l.G3e(this.xHb),this.$l.O4e(this.oqa),this.$l.H3e(this.tod),this.$l.P4e(this.qie))};this.Wze=()=>{za()||(this.mFa.IPg(),this.mFa.wQg());this.mFa.Tyg();const Ta=this.$l.qWh();r.AFrameworkApplication.fa.ka("HasDocumentEditRights")&&!Ta?this.mFa.b2g():E.ULS.sendTraceTag(558682911,306,50,"Default/Mandatory Labeling has been skipped because HasDocumentEditRights: {0}, IsClpBlockedByAppSpecificScenario: {1}",
r.AFrameworkApplication.fa.ka("HasDocumentEditRights"),Ta);r.AFrameworkApplication.ra.XB()};this.ute=(Ta,Hb)=>{Ta=this.pKf(Hb.title,Hb.hSc,38,Hb.Jhg,Hb.buttonText);r.AFrameworkApplication.ra.$g.Xlc(Ta)?E.ULS.sendTraceTag(34174785,306,50,"Add entry to BusinessBar succeeded. Policy message is shown to user."):E.ULS.sendTraceTag(34174784,306,10,"Failed to add entry to business bar. Policy message could not be shown to user.")};this.b5i=(Ta,Hb)=>{Hb.lVg&&(Ta=this.pKf(Hb.title,Hb.message,21,null,null,
Hb.Tla,Hb.buttonText),r.AFrameworkApplication.ra.$g.Xlc(Ta)?E.ULS.sendTraceTag(42074655,306,50,"Add entry to BusinessBar succeeded. CLP policy message is shown to user."):E.ULS.sendTraceTag(42074654,306,10,"Failed to add entry to business bar. CLP policy message could not be shown to user."))};this.oqa=()=>{};this.xHb=(Ta,Hb)=>{this.Ada&&(this.$l.oqa(Hb.ZJb),Ta=new F.a(Hb.title,Hb.message,null),Ta.id=Hb.ZJb,Ta.closeable=!0,Ta.image=3,Ta.addButton(Hb.buttonText,Hb.Tla,Hb.buttonText,!0),this.Ada.EF(Ta,
!1))};this.tod=(Ta,Hb)=>{this.Ada&&(Ta=new F.a(Hb.title,Hb.message,null),Ta.id=Hb.ZJb,Ta.closeable=!1,Ta.image=3,Ta.addButton(Hb.buttonText,Hb.Tla,Hb.buttonText,!1),this.Ada.EF(Ta,!1))};this.qie=()=>{}}get name(){return"Common.App.Policy"}init(){r.AFrameworkApplication.fa.ka("ShouldInitCommonPolicyPackage")&&(r.AFrameworkApplication.fa.ka("IsDataLossPreventionEnabledForUser")&&r.AFrameworkApplication.ra&&(this.$l=B(),this.$l.N4e(this.ute),E.ULS.sendTraceTag(36537375,306,50,"PolicyManager is created successfully."),
r.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.InitPolicyManagerEarlierEnabled",!1)?kb.a.get_instance().Fm(5,()=>{this.$l.JAc()}):kb.a.get_instance().Fm(6,()=>{this.$l.JAc()})),r.AFrameworkApplication.fa.ka("WacLabelingPoliciesIsEnabled")&&r.AFrameworkApplication.fa.ka("SupportsPolicies")?r.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.InitPolicyManagerEarlierEnabled",!1)?kb.a.get_instance().Fm(5,this.Sgg):kb.a.get_instance().Fm(6,this.Sgg):
(Ca.t$k(),Ca.GVc(!1)))}dispose(){}$n(Ta){Ta.register(671,"Common.App.Policy.Contracts.IPolicyManager").yi().Ei(()=>new fa(r.AFrameworkApplication.fa,r.AFrameworkApplication.rj,r.AFrameworkApplication.ra.yL,r.AFrameworkApplication.fa.Lj("MaxGetPolicyRetries",1),Object(C.a)(),r.AFrameworkApplication.ra.$g.kn));Ta.register(Ca,"Common.App.Policy.PolicyActor").as("Common.App.Policy.Contracts.IPolicyActor").yi().Ei(()=>new Ca(r.AFrameworkApplication.yh,r.AFrameworkApplication.ra,r.AFrameworkApplication.fa,
Object(y.b)()));this.Wh=Ta}pKf(Ta,Hb,uc,Sc=null,bc=null,vc=null,Xc=null){Ta=new F.a(Ta,Hb,null);Ta.id=uc;Ta.closeable=!0;Sc&&Ta.Dyh(bc,Sc);vc&&Ta.addButton(Xc,vc,Xc);return Ta}static main(){db.a.instance.Do(new gb)}}Object(h.a)(gb,"PackageManager",null,[11,12]);var Kb=a(9),ub=a(598),lb=a(428),Ba=a(39),ra=a(153),wb=a(40),mc=a(427),xb=a(216),Ec=a(83),ed=a(36),jd=a(254),Xd=a(1),Td=a(28),gc=a(264);class nc{constructor(){this.gSc=this.INg=null;this.AX=0}}Object(h.a)(nc,"ApplyPolicyContextParameters",null,
[]);var dc=a(2),Gc=a(908),vd=a(663),zd=a(58),Yb=a(54);class Pb{constructor(){this.ofb=this.annotationType=null;this.Dnb=this.RK=!1}}Object(h.a)(Pb,"AnnotationActivationOptions",null,[]);var $c=a(1155),wd=a(938),Bd=a(913);class tc extends wd.a{constructor(){super();this.source=this.automatic=this.recommended=null;this.H_=Object.assign(new Bd.a,{T_:tc.getTypeName(),B_:tc.getBaseTypes()})}static getTypeName(){return"AugLoop_SecurityClp_LabellingAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}
Object(h.a)(tc,"LabellingAnnotation",wd.a,[]);var Zc=a(924);class Ab extends Zc.a{constructor(){super();this.fullDocSITs=this.partialDocSITs=null;this.H_=Object.assign(new Bd.a,{T_:Ab.getTypeName(),B_:Ab.getBaseTypes()})}static getTypeName(){return"AugLoop_SecurityShared_SecurityShared"}static getBaseTypes(){return[]}}Object(h.a)(Ab,"SecurityShared",Zc.a,[]);class rb extends Ab{constructor(){super();this.existingLabelPriority=null;this.H_=Object.assign(new Bd.a,{T_:rb.getTypeName(),B_:rb.getBaseTypes()})}static getTypeName(){return"AugLoop_SecurityShared_CLP"}static getBaseTypes(){return["AugLoop_SecurityShared_SecurityShared"]}}
Object(h.a)(rb,"CLP",Ab,[]);var Fb=a(1356),jc=a(1129),Oc=a(1358);class cd extends wd.a{constructor(){super();this.classificationId=null;this.H_=Object.assign(new Bd.a,{T_:cd.getTypeName(),B_:cd.getBaseTypes()})}static getTypeName(){return"AugLoop_LinkedDataType_LinkedDataTypeAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}Object(h.a)(cd,"LinkedDataTypeAnnotation",wd.a,[]);var Ed=a(91);class Sd extends wb.a{constructor(Ta,Hb,uc,Sc,bc){super();this.Mbg=3;this.N_=this.Yo=null;this.qsd=
!1;this.Wsb=[];this.d6f=new Gc.a(vd.a.ZU());this.kee=0;this.pee=null;this.atc=(vc,Xc)=>{vc=Object(dc.a)(new Fb.a,{parentPath:["session","doc","security"],items:[Object(dc.a)(new jc.a,{id:"clp",body:Object(dc.a)(new rb,{existingLabelPriority:Xc.existingLabelPriority,partialDocSITs:Xc.ygf,fullDocSITs:Xc.xgf})})]});this.Wsb.push(vc);this.EUb()};this.c5g=(vc,Xc)=>{vc=Object(dc.a)(new Oc.a,{parentPath:["session","doc","security"],items:[Object(dc.a)(new jc.a,{id:"clp",body:Object(dc.a)(new rb,{existingLabelPriority:Xc.existingLabelPriority})})]});
this.Wsb.push(vc);this.EUb()};this.d5g=(vc,Xc)=>{vc=Object(dc.a)(new Oc.a,{parentPath:["session","doc","security"],items:[Object(dc.a)(new jc.a,{id:"clp",body:Object(dc.a)(new rb,{partialDocSITs:Xc.ygf,fullDocSITs:Xc.xgf})})]});this.Wsb.push(vc);this.EUb()};this.FA=()=>{E.ULS.sendTraceTag(537154588,306,50,`AutoPolicyManager::OnApplicationModeChanged - isEditMode:${this.$.isEditMode}.`);this.$.isEditMode?this.EUb():(this.businessBar.removeEntry(41),this.businessBar.removeEntry(40),this.Ebi())};this.JNj=
()=>{var vc;E.ULS.sendTraceTag(537154587,306,50,"AutoPolicyManager::OnAugmentationLoopSessionClose called.");null===(vc=this.Yo)||void 0===vc?void 0:vc.unregister("AutoPolicy");this.Yo=null};this.ivj=(vc,Xc)=>{var ad,Id;E.ULS.sendTraceTag(537154586,306,50,"AutoPolicyManager::LabellingAnnotationHandler called.");if(3===Xc.operationType)E.ULS.sendTraceTag(537154585,306,50,"AutoPolicyManager::LabellingAnnotationHandler Ignoring delete operation.");else{var ue=vc=null,Vd=null;if(Xc=Xc.annotation){if(null===
(ad=Xc.automatic)||void 0===ad?0:ad.id)vc=Xc.automatic.id;if(null===(Id=Xc.recommended)||void 0===Id?0:Id.id)ue=Xc.recommended.id,Xc.recommended.policyTip&&(Vd=Xc.recommended.policyTip);this.applyPolicyLabel(vc,ue,Vd,1)}else E.ULS.sendTraceTag(537154584,306,50,"AutoPolicyManager::LabellingAnnotationHandler LabellingAnnotation is null.")}};this.nxj=(vc,Xc)=>{E.ULS.sendTraceTag(537154582,306,50,"AutoPolicyManager::LinkedDataTypeLabellingAnnnotationHandler - Handler called.");3===Xc.operationType?E.ULS.sendTraceTag(537154581,
306,50,"AutoPolicyManager::LinkedDataTypeLabellingAnnnotationHandler - Received delete operation."):(vc=Xc.annotation)?(vc=vc.classificationId,this.applyPolicyLabel(vc,vc,null,2)):E.ULS.sendTraceTag(537154580,306,50,"AutoPolicyManager::LinkedDataTypeLabellingAnnnotationHandler - Received an empty annotation.")};this.CDg=(vc,Xc)=>{Xc?Xc.qXb&&this.businessBar.mM(41)?(this.businessBar.removeEntry(41),E.ULS.sendTraceTag(537154562,306,50,"Remove entry to RecommendedSensitivityLabelBusinessBarEntry succeeded.")):
!Xc.qXb&&this.businessBar.mM(40)&&(this.businessBar.removeEntry(40),E.ULS.sendTraceTag(537154561,306,50,"Remove entry to AutomaticSensitivityLabelBusinessBarEntry succeeded.")):E.ULS.sendTraceTag(537154563,306,15,"RemoveAutoPolicyBusinessBar is called but AddAutoPolicyBusinessBarEntryEventArgs is null.")};this.mUg=(vc,Xc)=>{Xc?Xc.qXb?(this.businessBar.WQk(Xc.title,Xc.message,Xc.buttonText,ad=>{Xc.Tla(ad);this.businessBar.mM(41)&&this.businessBar.removeEntry(41)}),E.ULS.sendTraceTag(537154531,306,
50,"Add entry to RecommendedSensitivityLabelBusinessBarEntry succeeded. Message is shown to user.")):(this.businessBar.pOk(Xc.title,Xc.message,Xc.buttonText,ad=>{Xc.Tla(ad);this.businessBar.mM(40)&&this.businessBar.removeEntry(40)}),E.ULS.sendTraceTag(537154530,306,50,"Add entry to AutomaticSensitivityLabelBusinessBarEntry succeeded. Message is shown to user.")):E.ULS.sendTraceTag(537154560,306,15,"ShowAutoPolicyBusinessBar is called but AddAutoPolicyBusinessBarEntryEventArgs is null.")};this.Tce=
Ta;this.policyManager=Hb;this.$=uc;this.fa=Sc;this.businessBar=bc;this.P$i();this.phk();this.disposed=!1}get ki(){return!this.disposed&&this.$.ea.ki}dispose(){var Ta;this.disposed||(this.disposed=!0,this.Fdi(),null===(Ta=this.Yo)||void 0===Ta?void 0:Ta.unregister("AutoPolicy"),this.Tce=this.policyManager=this.Yo=null,super.dispose())}ufb(Ta,Hb,uc,Sc,bc=!1){E.ULS.sendTraceTag(537154642,306,50,`AutoPolicyManager: ApplyAutoPolicyLabel called for LabellingSource ${Sc} with AutoLabelPresent: ${!!Ta}, RecommendedLabelPresent: ${!!Hb}, isStandard: ${bc}.`);
this.ki?this.Tce&&(this.NTh(Hb,Sc)?(this.pee=Hb,this.kee=Sc,this.d6f.ga(Sc,Hb)):Hb=this.pee,Ta=this.Tce.ufb(Ta,Hb,uc,bc),E.ULS.sendTraceTag(537154640,306,50,`AutoPolicyManager::ApplyAutoPolicyLabel - policyActor.ApplyAutoPolicyLabel returned ${Ta}.`)):E.ULS.sendTraceTag(537154641,306,15,`AutoPolicyManager: ApplyAutoPolicyLabel failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}NTh(Ta,Hb){if(!this.policyManager.Lea())return E.ULS.sendTraceTag(537154639,306,15,"CanShowRecommendedSensitivityLabel - Labels are not available."),
!1;const uc=this.policyManager.Nn;let Sc;({value:Sc}=this.d6f.wj(this.kee));let bc=null,vc=null,Xc=null;for(const ad of uc.SensitivityLabels)ad.Id===Ta&&(bc=ad),ad.Id===Sc&&(vc=ad),ad.Id===this.pee&&(Xc=ad);return vc&&vc.Id===Ta?(E.ULS.sendTraceTag(537154638,306,50,"AutoPolicyManager: CanShowRecommendedSensitivityLabel - Suppressing the recommendation since it is same as last recommendation from current source."),!1):this.businessBar.mM(41)&&this.kee!==Hb&&Xc&&(!bc||Xc.Order>=bc.Order)?(E.ULS.sendTraceTag(537154637,
306,50,"AutoPolicyManager: CanShowRecommendedSensitivityLabel - Suppressing the recommendation since current label priority is lower than last label priority."),!1):!0}iXf(){return Xd.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPSecurityNodeCreation",!1)}phk(){this.policyManager.G3e(this.mUg);this.policyManager.O4e(this.CDg);this.$.ea.cK(this.FA);this.iXf()&&(this.policyManager.SBh(this.atc),this.policyManager.TEh(this.c5g),this.policyManager.UEh(this.d5g))}Fdi(){this.businessBar.removeEntry(41);
this.businessBar.removeEntry(40);this.policyManager.vlk(this.mUg);this.policyManager.gok(this.CDg);this.$.ea.WH(this.FA);this.iXf()&&(this.policyManager.imk(this.atc),this.policyManager.Nok(this.c5g),this.policyManager.Ook(this.d5g))}P$i(){this.N_=new Gc.a(vd.a.ZU());const Ta=tc.getTypeName();this.N_.add(1,Object(dc.a)(new Pb,{annotationType:Ta,ofb:this.ivj,RK:!1,Dnb:!1}));this.N_.add(2,Object(dc.a)(new Pb,{annotationType:cd.getTypeName(),ofb:this.nxj,RK:!1,Dnb:!1}))}iZg(){for(const Ta of this.Wsb)this.Yo.submitOperation(Ta);
this.Wsb=[]}kqa(Ta){if(!this.N_.lh(Ta))return E.ULS.sendTraceTag(537154636,306,15,`AutoPolicyManager::RegisterAnnotation - AnnotationActivationOptions not available for LabellingSource ${Ta}.`),!1;if(this.N_.na(Ta).RK)return E.ULS.sendTraceTag(537154635,306,15,`AutoPolicyManager::RegisterAnnotation - Annotations already registered for LabellingSource ${Ta}.`),!0;this.N_.na(Ta).RK=!0;E.ULS.sendTraceTag(537154634,306,50,`AutoPolicyManager::RegisterAnnotation - Annotations registered for LabellingSource ${Ta}.`);
if(!this.$.isEditMode)return E.ULS.sendTraceTag(537154633,306,50,"AutoPolicyManager::RegisterAnnotation - Skipping AugmentationLoop initialization in view mode."),!0;this.EUb();return!0}EUb(){var Ta=0<this.Wsb.length;if(!Ta)for(const Hb of this.N_)if(Ta=Hb.value.RK||Ta)break;Ta?this.Yo?(E.ULS.sendTraceTag(537154627,306,50,"AutoPolicyManager::InitAugmentationLoopIfNecessary - AugmentationLoop already initialized."),this.Y0e(),this.iZg()):this.qsd?E.ULS.sendTraceTag(537154626,306,50,"AutoPolicyManager::InitAugmentationLoopIfNecessary - AugmentationLoop initialization in-progress."):
(this.qsd=!0,Ta=this.$.ua.FlightingSettings.AutoCLPStartUpDelay,E.ULS.sendTraceTag(537154625,306,50,`AutoPolicyManager::InitAugmentationLoopIfNecessary - Initializing AugmentationLoop in ${Ta} milliseconds.`),zd.a.instance.create(()=>{this.S$i()},Ta,Yb.a.xLh,!0,!0)):E.ULS.sendTraceTag(537154628,306,50,"AutoPolicyManager::InitAugmentationLoopIfNecessary - no registered annotations and operations.")}S$i(){Ba.TaskExtensions.Xa(Object(Ed.d)(t.a.resolve(n.p,{va:1})),Ta=>{this.Yo=Ta.result;this.qsd=!1;
this.Yo?(E.ULS.sendTraceTag(537154595,306,50,"AutoPolicyManager::InitAugmentationLoop - AugmentationLoopManager instantiated."),this.Yo.register(this.Yo.J5().n8("AutoPolicy").m8(this.JNj).build()),this.$.isEditMode?(this.Y0e(),this.iZg()):E.ULS.sendTraceTag(537154594,306,50,"AutoPolicyManager::InitAugmentationLoop - Skipping annotation activation in view mode.")):E.ULS.sendTraceTag(537154624,306,10,"AutoPolicyManager::InitAugmentationLoop - Failed to instantiate AugmentationLoopManager.")},this.ya,
3)}Y0e(){for(const Ta of this.N_)Ta.value.RK&&!Ta.value.Dnb&&this.activateAnnotation(Ta.key)}activateAnnotation(Ta){this.Yo.kqa("AutoPolicy",{annotationType:this.N_.na(Ta).annotationType,Ny:!0,BV:this.N_.na(Ta).ofb});this.N_.na(Ta).Dnb=!0;E.ULS.sendTraceTag(537154590,306,50,`AutoPolicyManager::ActivateAnnotation completed for LabellingSource ${Ta}.`)}Ebi(){for(const Ta of this.N_)Ta.value.Dnb&&this.xNb(Ta.key)}xNb(Ta){var Hb;null===(Hb=this.Yo)||void 0===Hb?void 0:Hb.r5k(this.N_.na(Ta).annotationType);
this.N_.na(Ta).Dnb=!1;E.ULS.sendTraceTag(537154589,306,50,`AutoPolicyManager::DeactivateAnnotation completed for LabellingSource ${Ta}.`)}applyPolicyLabel(Ta,Hb,uc,Sc){if(this.fa.ka("SupportsOfficeClientCoauthoring"))E.ULS.sendTraceTag(537154579,306,50,"AutoPolicyManager::ApplyPolicyLabel - SupportsOfficeClientCoauthoring is enabled."),this.ufb(Ta,Hb,uc,Sc);else{E.ULS.sendTraceTag(537154578,306,50,"AutoPolicyManager::ApplyPolicyLabel - SupportsOfficeClientCoauthoring is disabled.");const bc=vc=>{this.ufb(Ta,
Hb,uc,Sc,0===vc||1===vc||4===vc)};this.ONd(bc,()=>{bc(2)},this.Mbg)}}tsd(Ta,Hb){let uc=null,Sc=null;if(!({sensitivityLabel:uc,VVa:Sc}=this.d3g(Ta)).returnValue)return E.ULS.sendTraceTag(537154577,306,15,"AutoApplyOrRecommendPolicyLabel - Failed to set the sensitivity labels."),!1;if(Sc&&Sc.Order>=uc.Order)return E.ULS.sendTraceTag(537154576,306,50,"AutoApplyOrRecommendPolicyLabel - The applied label has a higher sensitivty."),!1;this.applyPolicyLabel(uc.Id,uc.Id,null,Hb);return!0}usd(Ta,Hb){Hb=!1;
let uc=null,Sc=null;if(!({sensitivityLabel:uc,VVa:Sc}=this.d3g(Ta)).returnValue)return E.ULS.sendTraceTag(537154575,306,15,"AutoApplyOrRecommendPowerBILabel - Failed to set the sensitivity labels."),{returnValue:!1,gob:Hb};if(Sc&&Sc.ParentId&&uc.ParentId&&Sc.ParentId===uc.ParentId)return E.ULS.sendTraceTag(537154574,306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - Label has a common parent with AppliedLabel."),{returnValue:!1,gob:Hb};if(Sc&&Sc.Order>=uc.Order)return E.ULS.sendTraceTag(537154573,
306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - Label does not have a higher priority than AppliedLabel."),{returnValue:!1,gob:Hb};if(this.fa.ka("SupportsOfficeClientCoauthoring"))E.ULS.sendTraceTag(537154572,306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - SupportsOfficeClientCoauthoring is enabled."),Ta=this.policyManager.Nn,Ta=!Ta.AppliedPolicyId||!Ta.PolicyLabelAssignmentMethod||Sa.e(Ta.PolicyLabelAssignmentMethod)===Sa.e("standard"),this.x8e(uc.Id,Ta);else{E.ULS.sendTraceTag(537154571,
306,50,"AutoPolicyManager::AutoApplyOrRecommendPowerBILabel - SupportsOfficeClientCoauthoring is disabled.");const bc=vc=>{this.x8e(uc.Id,0===vc||1===vc||4===vc)};this.ONd(bc,()=>{bc(2)},this.Mbg)}return{returnValue:!0,gob:Hb}}ONd(Ta,Hb,uc,Sc=0){if(this.ki){var bc=this.$.pa.ta.Vh();$c.b(this.$.pa.ta,this.$.ua.DocumentHostInfo.TenantId,vc=>{this.TSi(vc,Ta)},()=>{this.SSi(Ta,Hb,uc,Sc)},null,null,bc)}else E.ULS.sendTraceTag(537154570,306,15,`AutoPolicyManager: GetPolicyApplicationMethod failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}TSi(Ta,
Hb){E.ULS.sendTraceTag(537154569,306,50,"AutoPolicyManager: GetPolicyApplicationMethod web service call was successful.");this.ki?!Ta||jd.a(Ta)?E.ULS.sendTraceTag(537154567,306,15,Ta?"AutoPolicyManager: GetPolicyApplicationMethod result has non-status message.":"AutoPolicyManager: GetPolicyApplicationMethod result is null"):Hb(Ta.Result):E.ULS.sendTraceTag(537154568,306,50,`AutoPolicyManager: GetPolicyApplicationMethodSuccessCallback failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}SSi(Ta,
Hb,uc,Sc){E.ULS.sendTraceTag(537154566,306,15,"AutoPolicyManager: GetPolicyApplicationMethod web service call failed. Trying again");this.ki?Sc>=uc?(E.ULS.sendTraceTag(537154564,306,15,"AutoPolicyManager: GetPolicyApplicationMethod max retries exhausted."),Hb()):this.ONd(Ta,Hb,uc,Sc+1):E.ULS.sendTraceTag(537154565,306,50,`AutoPolicyManager: GetPolicyApplicationMethodFailureCallback failing because IsDisposed: ${this.disposed}, IsSessionActive: ${this.$.ea.ki}.`)}x8e(Ta,Hb){Hb?this.ufb(Ta,null,null,
3,!0):this.ufb(null,Ta,null,3,!1)}d3g(Ta){let Hb,uc;uc=Hb=null;if(!this.$.isEditMode)return{returnValue:!1,sensitivityLabel:Hb,VVa:uc};if(!this.policyManager.Lea())return E.ULS.sendTraceTag(537154529,306,15,"TryGettingSensitivityLabels - Labels are not available."),{returnValue:!1,sensitivityLabel:Hb,VVa:uc};const Sc=this.policyManager.Nn;if(!Sc)return E.ULS.sendTraceTag(537154528,306,15,"TryGettingSensitivityLabels - GetPolicyLabelsData returned an invalid result."),{returnValue:!1,sensitivityLabel:Hb,
VVa:uc};if(vb.a.Im(Sc.SensitivityLabels))return E.ULS.sendTraceTag(537154527,306,15,"TryGettingSensitivityLabels - Attempting to apply labels when there are no sensitivity labels available."),{returnValue:!1,sensitivityLabel:Hb,VVa:uc};const bc=Sc.AppliedPolicyId;for(const vc of Ta)for(const Xc of Sc.SensitivityLabels)Xc.Id===vc&&(!Hb||Hb.Order<Xc.Order)&&(Hb=Xc),Xc.Id===bc&&(uc=Xc);return Hb?{returnValue:!0,sensitivityLabel:Hb,VVa:uc}:(E.ULS.sendTraceTag(537154526,306,10,"TryGettingSensitivityLabels - None of the sensitivity labels matched."),
{returnValue:!1,sensitivityLabel:Hb,VVa:uc})}}Object(h.a)(Sd,"AutoPolicyManager",wb.a,[4]);var $d=a(201),be=a(16),Fe=a(12);class Pe extends $d.ErrorDialog{constructor(Ta){super(Ta,Pe.WJa(Ta))}dF(){super.dF();if(this.error.Appearance&1&&this.$.Ij&2){const Ta=this.getButton(0);be.DOMElementExtensions.ZOg(Ta.get_element(),Fe.a.instance.ia(1315));this.Fea(()=>{0===this.returnValue&&this.$.Ij&2&&(E.ULS.sendTraceTag(50373725,306,50,"BlockSenitivityLabelActionDialog : Opening the book in excel desktop."),
void t.a.resolve(n.se,{va:0}).then(Hb=>{Hb.jyd()}))})}}static WJa(Ta){return Ta.Ij&2?ed.a.nj(3,1,0,1975,0,-1237306487,"SensitivityLabelBlockApplyLabelOpenInDesktop"):ed.a.nj(1,1,0,1976,0,-313914360,"SensitivityLabelBlockApplyLabel")}}Object(h.a)(Pe,"BlockSenitivityLabelActionDialog",$d.ErrorDialog,[]);var hc=a(25),Lb=a(88),kc=a(7);class dd extends wb.a{constructor(Ta,Hb,uc,Sc,bc){super();this.statusBarManager=null;this.ytd=!1;this.Ola=null;this.k4c=!1;this.RMa=this.uoe=null;this.wP=this.Uce=!1;this.ITa=
this.QTe=this.Jsa=this.dVe=this.ly=null;this.btf=()=>{E.ULS.sendTraceTag(537154520,306,50,"PolicyManagerWrapper::EnableAutoLabellingInDocument - Triggered EnableAutoLabellingInDocument");const vc=this.ohk();E.ULS.sendTraceTag(537154519,306,50,`PolicyManagerWrapper::EnableAutoLabellingInDocument - Annotation registration result: ${vc}.`)};this.ute=(vc,Xc)=>{Xc?(this.ly=Xc.title,this.dVe=Xc.hSc,this.Jsa=Xc.buttonText,this.QTe=Xc.Jhg,this.Ula.Om(27,null),E.ULS.sendTraceTag(537154509,306,50,"Add entry to BusinessBar succeeded. Message is shown to user.")):
E.ULS.sendTraceTag(537154510,306,15,"ShowPolicyBusinessBar is called but PolicyTipventArgs is null.")};this.WVg=(vc,Xc)=>{const ad=Object(ra.a)(oc,Xc);ad?ad.lVg?(E.ULS.sendTraceTag(537154508,306,15,`ShowSetPolicyLabelFailureInBusinessBar :: SetPolicyLabelFailure because of ${ad.errorType}`),this.Ula.fRk(ad.title,ad.message,ad.buttonText,Id=>{ad.Tla&&(this.Ula.mM(54)&&this.Ula.removeEntry(54),ad.Tla(Id))})):E.ULS.sendTraceTag(537154506,306,50,"ShowSetPolicyLabelFailureInBusinessBar :: SetPolicyLabelFailure ShowMessage is false"):
(E.ULS.sendTraceTag(537154505,306,10,"ShowSetPolicyLabelFailureInBusinessBar :: SetPolicyLabelFailure args is null"),this.Ula.Om(48,null))};this.Wze=(vc,Xc)=>{this.Z1&&(E.ULS.sendTraceTag(537154504,306,50,"PolicyManagerWrapper: UpdateLabelInfo called"),Xd.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnablePolicyPackageRefactoring",!1)||(this.Z1.IPg(),this.Z1.wQg()),this.Z1.Tyg(),this.$.Ij&64&&(Xc.S1&&this.RMa?this.JIh():this.Z1.b2g()));this.fa.ka("SupportsOfficeClientCoauthoring")&&
(vc=this.Pz.Nn,this.ITa=vc.AppliedPolicyId,"null"===this.labelId&&(this.ITa=""),this.k4c&&(vc=vc.PolicyLabelAssignmentMethod&&Sa.e(vc.PolicyLabelAssignmentMethod)===Sa.e("standard")?4:2,this.applyPolicyLabel(this.labelId,vc,!0,this.uoe)));this.wYh();this.byf();this.$v()};this.jlg=()=>{this.Uce=!0;this.byf()};this.wqg=(vc,Xc)=>{E.ULS.sendTraceTag(42322116,306,50,`PolicyManagerWrapper.OnSetLabelSucceeded: Applying outcomes for change in policy label. ProtectedFile = ${r.AFrameworkApplication.protectedFile}, ApplyLabelFlag = ${Xc.AX}`);
this.applyPolicyLabel(Xc.gSc,Xc.AX,!1,null)};this.ANj=(vc,Xc)=>{this.ITa=Xc.gSc;if(ed.a.Lx(vc.Errors)){var ad=ed.a.fga(vc.Errors,[2045508683]);0<ad.length&&(vc.Errors=ed.a.WS(vc.Errors,[2045508683],"PolicyManagerWrapper: OnApplyManualPolicyLabelSuccessCallback"),this.$.ea.sx(vc.Errors));ad=ed.a.fga(vc.Errors,[2046680228]);0<ad.length&&(4===Xc.AX||1===Xc.AX)&&(vc.Errors=ed.a.WS(vc.Errors,[2046680228],"PolicyManagerWrapper: OnApplyManualPolicyLabelSuccessCallback"),this.$.ea.sx(vc.Errors));ad=vc=null;
for(var Id of this.Pz.Nn.SensitivityLabels)Td.a.equals(this.labelId,Id.Id,!1)&&(vc=Id),Td.a.equals(Xc.INg,Id.Id,!1)&&(ad=Id);Id={};Id.ApplyLabelFlag=Xc.AX;vc?(Id.currentLabel="Set",Id.currentLabelEnabled=vc.Enabled,Id.currentLabelName=vc.Name?"Set":"NotSet",Id.currentLabelParentId=vc.ParentId?"Set":"NotSet"):Id.currentLabel="NotSet";ad?(Id.serverLabel="Set",Id.serverLabelEnabled=ad.Enabled,Id.serverLabelName=ad.Name?"Set":"NotSet",Id.serverLabelParentId=ad.ParentId?"Set":"NotSet"):Id.serverLabel=
"NotSet";E.ULS.sendTraceTag(541638850,306,15,`PolicyManagerWrapper.OnApplyManualPolicyLabelSuccessCallback Failed. DiagnosticInfo : ${JSON.stringify(Id)}`)}};this.YMh=(vc,Xc)=>{if(!this.$.workbookContext.HasRoundTrippedHFPart)return!1;const ad=this.Pz.Nn;if(!ad)return E.ULS.sendTraceTag(537154502,306,15,"PolicyManagerWrapper.BlockSetSensitivityCall: policyLabelsData is null."),!1;let Id=null;for(const ue of ad.SensitivityLabels)Td.a.equals(ue.Id,vc,!1)&&(Id=ue);return Id&&this.Z6i(Id)?(E.ULS.sendTraceTag(50341186,
306,50,"PolicyManagerWrapper.BlockSetSensitivityCall: selectedSensitivityLabel has watermark label action."),this.sOk(Xc),!0):!1};this.ogj=()=>{let vc=!1;!this.$.ua.IsNewWorkbook||this.labelId&&this.labelId.length||(vc=!0);E.ULS.sendTraceTag(537154501,306,50,`PolicyManagerWrapper.IsANewFile: is this a new file : ${vc}`);return vc};this.sbg=(vc,Xc)=>{1===Xc.j7e?this.$.isEditMode?(E.ULS.sendTraceTag(537154500,306,50,"MandatoryLabellingHandler : Swtiching to view-mode."),this.$.Ma.qh(new Ec.a(-723527778,
0,this.$.hi,10,null))):E.ULS.sendTraceTag(537154499,306,50,"MandatoryLabellingHandler : App is already in view-mode."):(this.RMa=Xc.RMa,this.$.ea.cK(this.q8e),this.$.yzb(),E.ULS.sendTraceTag(537154498,306,50,"MandatoryLabellingHandler : Swtiching to edit-mode."),this.$.Ma.qh(new Ec.a(-8805455,0,this.$.hi,10,null)))};this.F2e=(vc,Xc)=>{Xc?(vc=!!(this.$.Ij&64),E.ULS.sendTraceTag(537154496,306,50,`AddMandatoryLabellingBusinessBar User has edit permission : ${vc}`),vc&&(this.$.yzb(),this.Ula.bQk(Xc.title,
Xc.message,Xc.buttonText,ad=>{Xc.Tla(ad)}))):E.ULS.sendTraceTag(537154497,306,15,"AddMandatoryLabellingBusinessBar is called but MandatoryLabellingAppHandlerEventArgs is null.")};this.gEg=()=>{this.Ula.mM(42)&&this.Ula.removeEntry(42)};this.E3g=(vc,Xc)=>{Xc.WLk&&(E.ULS.sendTraceTag(527716803,306,50,"PolicyManagerWrapper.udpLabelingAppHandler: Open the document in the client when the applied label is a UDP label."),void t.a.resolve(n.se,{va:0}).then(ad=>{ad.jyd()}))};this.q8e=()=>{this.RMa&&this.$.isEditMode?
(this.$.ea.WH(this.q8e),this.wRb()):E.ULS.sendTraceTag(537154467,306,15,`ApplyMandatoryLabelOnEditMode : mandatoryPolicyId empty ${!this.RMa} , edit mode : ${this.$.isEditMode}.`)};this.Ixa=()=>{const vc=this.$.ea.Qq;vc&&!Td.a.equals(vc.AppliedPolicyLabelId,this.labelId,!1)&&(E.ULS.sendTraceTag(537154464,306,50,"PolicyManagerWrapper.HandleWorkbookMetadataChanged: Calling GetPolicyLabels to update statusbar and ribbon control."),E.ULS.shipAssertTag(537154463,306,this.$.isEditMode,"PolicyManagerWrapper.HandleWorkbookMetadataChanged policyId cannot change in read-only mode, this can happen if right policy id is not read from server."),
this.fa.ka("SupportsOfficeClientCoauthoring")&&this.$.isEditMode&&(this.k4c=!0,this.uoe=vc.AppliedPolicyLabelId),this.ITa=vc.AppliedPolicyLabelId,this.wRb())};this.wWd=()=>{let vc=!0;if(!this.$.ea.K_)for(const Xc of this.$.ea.Wt)if(!Xc.SupportsClientIsMipTrusted){vc=!1;break}E.ULS.sendTraceTag(537154462,306,50,`PolicyManagerWrapper.IsEveryCoauthorInSessionClientMipTrusted : ${vc}`);return vc};this.Dmg=()=>{E.ULS.sendTraceTag(537154461,306,50,"PolicyManagerWrapper.OnLabelUpdate: RTC notification received");
this.k4c=!0;this.wRb()};this.xsg=(vc,Xc)=>{this.$.la.fi(211,ad=>{ad.HOa(Xc.TYk,kc.a.JGa)})};this.$=Sc;this.Pz=Ta;this.Ula=uc;this.fa=bc;this.Pz.N4e(this.ute);this.Z1=Hb}initialize(){this.fa.ka("SupportsPolicies")?(this.ITa=this.fa.Ya("AppliedPolicyId"),this.Z1.ho(),this.$.la.fi(29,Ta=>{this.statusBarManager=Ta;Ta.hO(this)}),this.$v(),Td.a.Im(this.fa.Ya("HostUserId"))||this.X6j(),this.Z1.rhk(this.YMh),this.Z1.kik(this.ogj),this.Pz.mhk(this.wWd),this.wP=!0):xa.c()&&appChrome.api.dispatch(appChrome.actions.updateControlHiddenState("Sensitivity",
!0));!Td.a.Im(this.fa.Ya("HostUserId"))&&Xd.EwaSettings.Ra(158)&&this.$.ea.Vn.get(45)&&(E.ULS.sendTraceTag(537154524,306,50,"DataLossPrevention feature is Enabled and launched on Excel."),this.pKi());this.Z1.iFh(this.xsg)}oy(Ta){this.addHandler("LabelInfoChangedKey",Ta)}cy(Ta){this.removeHandler("LabelInfoChangedKey",Ta)}rr(){return!0}Ay(Ta,Hb){if("QueryPolicyLabel"!==Ta)return!1;if(this.Tqa())return Hb.Visible=!1,!0;!Td.a.Im(Hb.LabelText)&&hc.a.Mo(this.$)&&window.setTimeout(()=>{appChrome.api.dispatch(appChrome.actions.setControlCustomTooltip(Lb.a.Rqc,
Hb.Alt))},0);Hb.Visible=!0;return 32===r.AFrameworkApplication.yh.ek(m.a.Bub,2,Hb)}dispose(){this.statusBarManager&&(this.statusBarManager.tN(this),this.statusBarManager=null);this.Z1.R2c();this.ytd=!1;this.Pz.Bok(this.WVg);this.Pz.Cok(this.wqg);this.$.ea.LA(this.Ixa);if(this.fa.ka("SupportsOfficeClientCoauthoring")){const Ta=this.$.la.kh(292);Ta&&Ta.knk(this.Dmg)}this.Pz.xlk(this.F2e);this.Pz.hok(this.gEg);this.Pz.snk(this.sbg);this.Pz.Mok(this.E3g);this.Pz.Hmk(this.btf);this.Z1.apk(this.xsg);this.Ola&&
(this.Ola.dispose(),this.Ola=null);super.dispose()}get title(){return this.ly}get hSc(){return this.dVe}get linkText(){return this.Jsa}get iWj(){return this.QTe}get labelId(){return this.ITa}tsd(Ta,Hb){if(!this.fa.ka("SupportsPolicies"))return E.ULS.sendTraceTag(537154523,306,15,"AutoApplyOrRecommendPolicyLabel - Called when SupportPolicies is disabled."),!1;if(!this.Uce)return E.ULS.sendTraceTag(537154522,306,15,"AutoApplyOrRecommendPolicyLabel - PolicyData hasn't been received yet."),!1;if(vb.a.Im(Ta))return!1;
this.Ola||this.qTd();return this.Ola.tsd(Ta,Hb)}Qod(Ta){return this.Z1.Qod(Ta)}$v(){this.raiseEvent("LabelInfoChangedKey")}pKi(){kb.a.get_instance().Fm(10,()=>{this.Pz.JAc()})}X6j(){kb.a.get_instance().Fm(10,()=>{this.Pz.bIb(this.Wze);this.Pz.zCh(this.jlg);this.Pz.yCh(this.jlg);this.Pz.Wpd(this.WVg);this.Pz.X4e(this.wqg);this.$.ea.pz(this.Ixa);this.Pz.H3e(this.F2e);this.Pz.P4e(this.gEg);this.Pz.lDh(this.sbg);this.Pz.REh(this.E3g);if(this.fa.ka("SupportsOfficeClientCoauthoring")){const Ta=this.$.la.kh(292);
Ta&&Ta.bDh(this.Dmg)}E.ULS.sendTraceTag(537154521,306,50,"PolicyManagerWrapper: ApplyAutomaticPolicyLabel enabled and registered GetAutoPolicyLabelHandler");this.Pz.wCh(this.btf);this.Pz.v1f()?this.Pz.N7j():(this.Sui(),this.$.Spe("sensitivity",!0))})}Sui(){this.fa.ka("SupportsOfficeClientCoauthoring")||this.labelId&&this.labelId.length?this.wRb():this.OEi(this.$.ua.DocumentHostInfo.TenantId)}qTd(){this.Ola=new Sd(this.Z1,this.Pz,this.$,this.fa,this.Ula)}ohk(){if(!this.fa.ka("SupportsPolicies"))return E.ULS.sendTraceTag(537154518,
306,10,"PolicyManagerWrapper::RegisterAugmentationLoopAnnotations called when CLP is disabled."),!1;this.Ola||this.qTd();return this.Ola.kqa(1)}usd(Ta,Hb){if(!this.fa.ka("SupportsPolicies"))return E.ULS.sendTraceTag(537154517,306,10,"PolicyManagerWrapper::AutoApplyOrRecommendPowerBILabel called when CLP is disabled."),{returnValue:!1,gob:!1};if(!this.Uce)return E.ULS.sendTraceTag(537154516,306,15,"PolicyManagerWrapper::AutoApplyOrRecommendPowerBILabel called before PolicyData fetch is complete."),
{returnValue:!1,gob:!0};this.Ola||this.qTd();return this.Ola.usd(Ta,Hb)}OEi(Ta){E.ULS.sendTraceTag(537154514,306,50,`PolicyManagerWrapper: Doing GetPolicyLabelId web service call with tenantId length ${Ta.length}`);const Hb=this.$.pa.ta.Vh();$c.c(this.$.pa.ta,Ta,uc=>{this.JWk(uc)},null,null,null,Hb)}JWk(Ta){E.ULS.sendTraceTag(537154513,306,50,"PolicyManagerWrapper: GetPolicyLabelId web service call was successful");Ta&&!jd.a(Ta)&&(this.ITa=Ta.Result);this.wRb();this.labelId?E.ULS.sendTraceTag(537154512,
306,50,`PolicyManagerWrapper: Fetched LabelId length from custom.xml is ${this.labelId.length}`):E.ULS.sendTraceTag(537154511,306,50,"PolicyManagerWrapper: LabelId is invalid")}wRb(){this.Pz.xRb(this.labelId,void 0,void 0,!1)}wYh(){hc.a.hV()&&Xd.EwaSettings.isChangeGateEnabled("OfficeVSO:8386937_NoCopilotTaskPaneWhenNoExtractPermissions")&&(!r.AFrameworkApplication.protectedFile&&!r.AFrameworkApplication.EAa||r.AFrameworkApplication.enableExtractForProtectedFile||this.$.si(762629271,-1,0,null))}byf(){if(!this.ytd){this.$.Dm();
this.ytd=!0;this.Ula.VPf();const Ta={};Ta.hasLabel=!!this.labelId&&0<this.labelId.length;Ta.isProtectedFile=this.fa.ka("ProtectedFile");Ta.SupportsPolicies=this.fa.ka("SupportsPolicies");Ta.AreLabelsAvailableForDisplay=this.Pz.Lea();Ta.SupportsOfficeClientCoauthoring=this.fa.ka("SupportsOfficeClientCoauthoring");Ta.IsAnonymousUser=this.fa.ka("IsAnonymousUser");E.ULS.sendTraceTag(51238051,306,50,`CLPUsage : ${JSON.stringify(Ta)}`)}}JIh(){this.Z1.KIh(this.RMa);this.RMa=null}Z6i(Ta){for(const Hb of Ta.LabelActions)if(Td.a.equals(Hb.Name,
"ApplyWatermark",!1))return!0;return!1}sOk(Ta){Ta?(new Pe(this.$)).Xs():E.ULS.sendTraceTag(537154465,306,50,"PolicyManagerWrapper.showBlockApplyLabelDialogDialog: Watermark Dialog box called with showDialog set to false from autoapply.")}applyPolicyLabel(Ta,Hb,uc,Sc){const bc=yc.c(this.Pz.Nn);if(void 0===Ta||null===Ta)Ta="";const vc=new nc;vc.gSc=Ta;vc.INg=Sc;vc.AX=Hb;const Xc=this.$.pa.ta;mc.a(this.$.userOperationManager,(ad,Id,ue)=>$c.a(Xc,bc,Ta,this.$.ua.DocumentHostInfo.TenantId,Hb,uc,gc.c.call(null,
this.ANj,ad),null,ue,vc),ad=>new xb.a(222,0,ad),null);this.k4c=!1;this.uoe=null}Tqa(){const Ta=t.a.nh(n.Ce);return this.wP&&Ta?Ta.wP():!1}}Object(h.a)(dd,"PolicyManagerWrapper",wb.a,[155,156,690]);class yb extends lb.a{constructor(Ta){super();this.$=Ta;this.gm()}create(){const Ta=Object(Ed.d)(t.a.resolve(n.C,{va:this.xh})),Hb=r.AFrameworkApplication.rj,uc=r.AFrameworkApplication.fa;Ba.TaskExtensions.Xa(Ta,()=>{try{let Sc,bc,vc=void 0;const Xc=Xd.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableDynamicWatermarking",
!1);Xc&&(vc=this.$.JNf());Xd.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.EnableSensitivityLabelingInOfficeJS",!1)?(v.a.instance.register(671,"Common.App.Policy.Contracts.IPolicyManager").yi().Ei(()=>new fa(uc,Hb,r.AFrameworkApplication.ra.yL,this.$.ua.MaxGetPolicyRetries,v.a.instance.fj("Common.App.ApplicationFeatureHelper.IApplicationFeatureHelper"))),Sc=v.a.instance.W5b("Common.App.Policy.Contracts.IPolicyManager"),v.a.instance.register(Ca,"Common.App.Policy.PolicyActor").as("Common.App.Policy.Contracts.IPolicyActor").yi().Ei(()=>
new Ca(r.AFrameworkApplication.yh,r.AFrameworkApplication.ra,r.AFrameworkApplication.fa,Sc,Xc&&vc?[vc]:null)),bc=v.a.instance.W5b("Common.App.Policy.Contracts.IPolicyActor")):(Sc=new ub.a(()=>new fa(uc,Hb,r.AFrameworkApplication.ra.yL,this.$.ua.MaxGetPolicyRetries,v.a.instance.fj("Common.App.ApplicationFeatureHelper.IApplicationFeatureHelper"))),bc=new ub.a(()=>new Ca(r.AFrameworkApplication.yh,r.AFrameworkApplication.ra,r.AFrameworkApplication.fa,Sc,Xc&&vc?[vc]:null)));let ad=this.$.la.kh(274);ad||
(ad=new dd(Sc.value,bc.value,Ta.result,this.$,r.AFrameworkApplication.fa),this.$.la.Hh(274,ad),ad.initialize());this.Bk(ad)}catch(Sc){throw E.ULS.sendTraceTag(537154525,306,10,`PolicyManager was not created successfully [Exception: ${Sc.toString()}]`),Sc;}},this.ya,3)}static Ba(Ta){Ta.la.Hh(275,new yb(Ta))}}Object(h.a)(yb,"PolicyManagerFactory",lb.a,[]);Type.registerNamespace("Common.App.Policy");gb.main();(()=>{Kb.a.gh(Ta=>{yb.Ba(Ta)})})();String(c);window.___1710758652293_closurehack=c}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.policy.js.map/3b4f7ab7e3ee86e2dff5011cb2cd3cf6/EwaTS.policy.js.map